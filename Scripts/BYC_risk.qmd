<<<<<<< HEAD
---
title: "BYC_RISK"
author: "CMD"
format: html
editor: visual
---

# simplesacrois

## Data set-up

```{r data}
library(dplyr)
library(arrow)
library(ggplot2)
library(data.table)
library(readr)
library(sf)
library(stringr)
library(classInt)
library(ggplot2)
library(RColorBrewer)
library(data.table)
library(ggpubr) 
library(tidyr)
library(ggOceanMaps)
library(cowplot)


ds<-open_dataset("D:/Data/simplesacrois")

# Select zones in English Channel (27.7.e, 27.7.d) + 6 stat rectangles from 27.7.h

select_manche <- ds %>%
  filter(AN %in% c(2011,2012,2016,2021)) %>%
  filter(SECT_COD_SACROIS_NIV3 %in% c("27.7.e", "27.7.d") | 
           (SECT_COD_SACROIS_NIV3 == "27.7.h" & SECT_COD_SACROIS_NIV5 %in% c("27E3","27E4","26E4","26E3","25E3","25E4"))) %>%
  select(NAVS_COD, DATE_SEQ, MAREE_DATE_DEP, TP_NAVIRE_SACROIS,SECT_COD_SACROIS_NIV4, SECT_COD_SACROIS_NIV5, SECT_COD_SACROIS_NIV6, ESP_COD_FAO) %>%
  collect()

# Remove data where fishing hours aren't recorded
select_manche <- subset(select_manche,!is.na(TP_NAVIRE_SACROIS))



####################################################################################

                        ########## ADDING SEASONS ##########


library(dplyr)
library(lubridate)

# Creating month, year, season columns
select_manche$MAREE_DATE_DEP <- dmy_hms(select_manche$MAREE_DATE_DEP)
select_manche$Month <- month(select_manche$MAREE_DATE_DEP)
select_manche$Year <- year(select_manche$MAREE_DATE_DEP)

select_manche$Season <- cut(select_manche$Month, 
                            breaks = c(0, 3, 5, 9, 12, Inf), 
                            labels = c("Winter", "Spring", "Summer", "Fall", "Winter"),
                            include.lowest = TRUE)


####################################################################################

                        ########## NAVS_COD_YEAR ##########


#### Creation de NAVS_COD_YEAR pr match avec data de flottille

library(data.table)
select_manche <- as.data.table(select_manche)

# Create NAVS_COD_YEAR column by pasting NAVS_COD and DATE_SEQ
select_manche[, NAVS_COD_YEAR := paste(NAVS_COD, substr(DATE_SEQ, 7, 10), sep = "_")]
select_manche <- select(select_manche, -MAREE_DATE_DEP)



####################################################################################

                        ########## FPC LOAD & left_join ##########

# for loop to read data from 2020 - 2022
setwd("D:/Data")


FPC=data.table()

for (i in 2007:2023) {
  
  setwd(paste0("D:/Data/",i));
  
  FPC<-rbind(fread(dir(getwd(), pattern="ISIH-504549-vueAnnuelleFpc"), dec=",", encoding="Latin-1", select= c("NAVS_COD", "DATE_REF", "DCR_FLOTTILLE_LIB", "DCR_S_FLOTTILLE_LIB")), FPC)
}

#"NAVLC1_COD","NAVLC2_COD","NAVLC3_COD","NAVLC4_COD","NAVLC5_COD","NAVLC6_COD", "NAVLC7_COD", "NAVLC8_COD", #"NAVLC9_COD"
### Produce unique vessel ID based on year

FPC$NAVS_COD_YEAR=paste(FPC[,NAVS_COD], str_sub(FPC[,DATE_REF],7,10), sep="_")
FPC[,c("DATE_REF", "NAVS_COD"):=NULL]

#Keep only the ones that match w select_manche

 #FPC=FPC[NAVS_COD_YEAR %in% unique(select_manche[,NAVS_COD_YEAR]),]


####

select_manche <- select_manche %>%
  left_join(FPC, by = c("NAVS_COD_YEAR" = "NAVS_COD_YEAR")) %>%
  filter (DCR_FLOTTILLE_LIB %in% c("Chalutiers de fond", "Chalutiers pélagiques", "Fileyeurs"))



### Rectangle geometry



####################################################################################

                        ########## Geometry data ##########

rect <- readRDS("D:/Data/rect.rds")

                        ########## left_join SACROIS ##########

select_manche <- select_manche %>%
  left_join(select(rect, SECT_COD,), by = c("SECT_COD_SACROIS_NIV5" = "SECT_COD"))




### ICES


#this isn't used nor can it be used since it doesn't work


ICES <- read_csv("D:/Data/Aires_decoupage_ICES.csv", col_types = cols(.default = "c"))


ICES <- ICES %>%
  filter(`ICES division` %in% c("27.7.e", "27.7.d") | 
           (`ICES division` == "27.7.h" & statistic_rectangle %in% c("27E3","27E4","26E4","26E3","25E3","25E4"))) 



####################################################################################

                        ########## AREA / RECTANGLE ##########


#ICES$Area_stat_subrect_m2 <- as.numeric(ICES$Area_stat_subrect_m2)

# Some sub_rectangles appear in both divisions : we need to add up their areas and plug them back
# into one division (27.7.d), and re-calculate the statistic_rectangle area
# Then we can adjust fishing_effort based on the area of each statistic_rectangle and 
# Get a realistic representation of the fishing_effort in coastal areas for eg

####

# Grabbing the duplicated sub_rectangles appearing in both divisions and adding up their areas

#rect_duplicates <- ICES %>%
#  group_by(statistic_rectangle) %>%
# filter(n_distinct(`ICES division`) > 1) %>%
#  summarise(duplicates_area = sum(as.numeric(Area_stat_rect_m2)))
  
#si on fait les maths manuellement ca check out

# assigning a ICES division to duplicated rectangles, since they either fall in .d or .e 
# we put them in d since the largest area of each rectangle belongs to that section

#rect_duplicates$`ICES division` <- "27.7.d"

# Summing up the area of duplicated s-rectangle values
#rect_duplicates <- rect_duplicates %>%
#  group_by(statistic_rectangle, satistic_subrectangle) %>%
#  summarise(total_area = sum(duplicates_area))


library(data.table)

ICES=as.data.table(ICES)
ICES[, Area_stat_rect_m2:=as.numeric(Area_stat_rect_m2)]

# Creating unique ID for each stat_rectangle per ICES division (since we have duplicates) 

ICES[, rect_divis:=paste0(`ICES division`, statistic_rectangle)]


# Remove duplicated IDs, and keeping only the columns we need
# This alleviates the data set and removes the subrectangle column which 1) we don't need, 2) requires more code to clean up

ICES=ICES[!duplicated(rect_divis), .(`ICES division`, ICES_division_Area_km2, statistic_rectangle, Area_stat_rect_m2, rect_divis)]

# Grabs duplicated stat_rectangle, found in two different divisions instead of being assigned to only 1

problematic_rect= ICES[statistic_rectangle %in% ICES[duplicated(statistic_rectangle), statistic_rectangle] ,]

# Sum up the areas of the divided/duplicated stat_rectangle

new_area_rect_stat=tapply(problematic_rect$Area_stat_rect_m2, problematic_rect$statistic_rectangle, sum)

# Right now ICES dataset still has the duplicated stat_rectangle, so we remove them: 

ICES=ICES[!duplicated(statistic_rectangle)]

# Now that we have the new areas and have removed duplicated stat_rectangles in the initial dataset (ICES), we go ahead and assign the new areas to the stat_rectangles by assigning that area with the condition %in% and grabbing the names of the new_area_rect_stat so the area is assigned to the correct stat_rectangle

ICES[ statistic_rectangle %in% names(new_area_rect_stat), Area_stat_rect_m2:=new_area_rect_stat]

# and voila 

ICES$Area_stat_rect_km2 <- ICES$Area_stat_rect_m2 / 1000000


# Left join with select_manche data set 
select_manche <- select_manche %>%
  left_join(select(ICES, statistic_rectangle, Area_stat_rect_km2), 
            by = c("SECT_COD_SACROIS_NIV5" = "statistic_rectangle"))





```

### Campagnes names

```{r campagnes names}


# Grabbing specific year/months combos to match with Pelagis' megafauna surveys

manche_SAMM_I_summer <- select_manche %>%
  filter((Year == 2012 & Month %in% c(6,7,8)))

manche_SAMM_I_winter <- select_manche %>%
  filter((Year == 2011 & Month %in% c(11,12))|
  (Year == 2012 & Month %in% c(1,2)))

manche_SAMM_II_winter <- select_manche %>%
  filter((Year == 2021 & Month %in% c(1,2,3)))

manche_SCANS_III_summer <- select_manche %>%
  filter((Year == 2016 & Month %in% c(6,7,8)))

# Added June & August for summers, otherwise we don't have enough data

# Adding a column to each dataset indicating its source which will match the name of megafauna surveys 

manche_SAMM_I_summer <- manche_SAMM_I_summer %>%
  mutate(Source = "manche_SAMM_I_summer")

manche_SAMM_I_winter <- manche_SAMM_I_winter %>%
  mutate(Source = "manche_SAMM_I_winter")

manche_SAMM_II_winter <- manche_SAMM_II_winter %>%
  mutate(Source = "manche_SAMM_II_winter")

manche_SCANS_III_summer <- manche_SCANS_III_summer %>%
  mutate(Source = "manche_SCANS_III_summer")


# Remove select_manche to alleviate environment 

#rm(select_manche)


# Combine the data tables

manche_campagnes <- bind_rows(
  manche_SAMM_I_summer,
  manche_SAMM_I_winter,
  manche_SAMM_II_winter,
  manche_SCANS_III_summer
)

winter <- bind_rows(manche_SAMM_I_winter,manche_SAMM_II_winter)
summer <- bind_rows(manche_SAMM_I_summer,manche_SCANS_III_summer)

```

# Fishing effort / flottille

```{r EFFORT / FLOTTILLE}

####################################################################################

                        ########## EFFORT / FLOTTILLE ##########

# Removing any rows with nothing in it 

manche_campagnes <- manche_campagnes %>%
  filter(SECT_COD_SACROIS_NIV5 != "")

# Fishing effort based on fishing hours per DCR_FLOTTILLE 

fish_effort <- manche_campagnes %>%
  distinct(NAVS_COD_YEAR,.keep_all = TRUE) %>%
  group_by(DCR_FLOTTILLE_LIB, SECT_COD_SACROIS_NIV5, Source, geometry, ESP_COD_FAO) %>%
  summarize(
    mean_hrs_fish = mean(TP_NAVIRE_SACROIS, na.rm = TRUE),
    total_hrs_fish = sum(TP_NAVIRE_SACROIS, na.rm = TRUE))


fish_effort <- fish_effort %>%
  filter_all(all_vars(!is.na(.))) 


# Grouping data based on season 

## Winter


fish_winter <- winter %>%
  distinct(NAVS_COD_YEAR,.keep_all = TRUE) %>%
  group_by(DCR_FLOTTILLE_LIB, SECT_COD_SACROIS_NIV5, geometry) %>%
  summarize(
    mean_hrs_fish = mean(TP_NAVIRE_SACROIS, na.rm = TRUE),
    total_hrs_fish = sum(TP_NAVIRE_SACROIS, na.rm = TRUE))


fish_winter <- fish_winter %>%
  filter_all(all_vars(!is.na(.))) 

fish_winter <- fish_winter %>%
  filter(SECT_COD_SACROIS_NIV5 != "")

## Summer

fish_summer <- summer %>%
  distinct(NAVS_COD_YEAR,.keep_all = TRUE) %>%
  group_by(DCR_FLOTTILLE_LIB, SECT_COD_SACROIS_NIV5, geometry) %>%
  summarize(
    mean_hrs_fish = mean(TP_NAVIRE_SACROIS, na.rm = TRUE),
    total_hrs_fish = sum(TP_NAVIRE_SACROIS, na.rm = TRUE))


fish_summer <- fish_summer %>%
  filter_all(all_vars(!is.na(.))) 

fish_summer <- fish_summer %>%
  filter(SECT_COD_SACROIS_NIV5 != "")



####################################################################################

                        ########## EFFORT / RECTANGLE AREA ##########


# Adding the area data to the fishing effort datasets

fish_effort <- fish_effort %>%
  left_join(select(ICES, statistic_rectangle, Area_stat_rect_km2), 
            by = c("SECT_COD_SACROIS_NIV5" = "statistic_rectangle"))


fish_winter <- fish_winter %>%
  left_join(select(ICES, statistic_rectangle, Area_stat_rect_km2), 
            by = c("SECT_COD_SACROIS_NIV5" = "statistic_rectangle"))


fish_summer <- fish_summer %>%
  left_join(select(ICES, statistic_rectangle, Area_stat_rect_km2), 
            by = c("SECT_COD_SACROIS_NIV5" = "statistic_rectangle"))


#select_manche <- select_manche %>%
#  left_join(select(rect, SECT_COD,), by = c("SECT_COD_SACROIS_NIV5" = "SECT_COD"))

#### calculation of fish effort that is proportionate to the rectangle area 

fish_effort$hrs_km2 <- fish_effort$total_hrs_fish / fish_effort$Area_stat_rect_km2

fish_winter$hrs_km2 <- fish_winter$total_hrs_fish / fish_winter$Area_stat_rect_km2

fish_summer$hrs_km2 <- fish_summer$total_hrs_fish / fish_summer$Area_stat_rect_km2


#####

fish_summer <- fish_summer %>% filter (Area_stat_rect_km2 > 1)

fish_winter <- fish_winter %>% filter (Area_stat_rect_km2 > 1)


# Very redundant and maybe there's a more concise way of going about this
# But I need to calculate/grab fishing effort per megafauna survey period so 
# When I do the st_intersection, the data matches and doesn't take forever to load

fish_effort <- fish_effort %>% st_as_sf()



effort_SAMM_I_summer <- fish_effort %>%
  filter(Source == "manche_SAMM_I_summer")
effort_SAMM_I_winter <- fish_effort %>%
  filter(Source == "manche_SAMM_I_winter")
effort_SAMM_II_winter <- fish_effort %>%
  filter(Source == "manche_SAMM_II_winter")
effort_SCANS_III_summer <- fish_effort %>%
  filter(Source == "manche_SCANS_III_summer")


summer_effort <- rbind(effort_SAMM_I_summer, effort_SCANS_III_summer)
winter_effort <- rbind(effort_SAMM_I_winter, effort_SAMM_II_winter)


```

### Fish_effort maps

```{r fishing effort map}

# Maps of fishing effort


#get the limx and limy for coord_sf
rangex<-st_bbox(fish_effort)[c(1,3)]
rangey<-st_bbox(fish_effort)[c(2,4)]


## use basemap 

# Fishing effort / campagnes

fish_winter<-ggplot()+theme_bw()+
  geom_sf(data=fish_winter,aes(fill= hrs_km2, geometry = geometry))+
  borders("world",fill="light grey",colour="light grey")+
  scale_fill_distiller(palette='Spectral',name="Value (unit)", trans = "log10")+
  coord_sf(rangex,rangey)+
  xlab("Longitude")+ylab("Latitude")+
  ggtitle("log Fishing effort per survey season")+
  facet_wrap(~DCR_FLOTTILLE_LIB)
fish_winter


fish_summer<-ggplot()+theme_bw()+
  geom_sf(data=fish_summer,aes(fill= hrs_km2, geometry = geometry))+
  borders("world",fill="light grey",colour="light grey")+
  scale_fill_distiller(palette='Spectral',name="Value (unit)", trans = "log10")+
  coord_sf(rangex,rangey)+
  xlab("Longitude")+ylab("Latitude")+
  ggtitle("log Fishing effort per survey season")+
  facet_wrap(~DCR_FLOTTILLE_LIB)
fish_summer


# manche_SAMM_I_summer

  
ggplot() +
  theme_bw() +
  geom_sf(data = effort_SAMM_I_summer,
          aes(fill = hrs_km2)) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette = 'Spectral', name = "Value (unit)") +
  coord_sf(xlim = rangex, ylim = rangey) +  
  xlab("Longitude") + ylab("Latitude") +
  ggtitle("log hrs/km2 manche_SAMM_I_summer") +
  facet_wrap(~ DCR_FLOTTILLE_LIB)

#trans="log10"



# manche_SAMM_I_winter

ggplot() +
  theme_bw() +
  geom_sf(data = effort_SAMM_I_winter,
          aes(fill = log_fish_effort)) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette = 'Spectral', name = "Value (unit)") +
  coord_sf(xlim = rangex, ylim = rangey) +  # Assuming `rangex` and `rangey` are defined
  xlab("Longitude") + ylab("Latitude") +
  ggtitle("log_effort manche_SAMM_I_winter") +
  facet_wrap(~ DCR_FLOTTILLE_LIB)



# manche_SAMM_II_winter


ggplot() +
  theme_bw() +
  geom_sf(data = effort_SAMM_II_winter,
          aes(fill = log_fish_effort)) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette = 'Spectral', name = "Value (unit)") +
  coord_sf(xlim = rangex, ylim = rangey) +  # Assuming `rangex` and `rangey` are defined
  xlab("Longitude") + ylab("Latitude") +
  ggtitle("log_effort manche_SAMM_II_winter") +
  facet_wrap(~ DCR_FLOTTILLE_LIB)



# manche_SCANS_III_summer


ggplot() +
  theme_bw() +
  geom_sf(data = effort_SCANS_III_summer,
          aes(fill = log_fish_effort)) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette = 'Spectral', name = "Value (unit)") +
  coord_sf(xlim = rangex, ylim = rangey) +  # Assuming `rangex` and `rangey` are defined
  xlab("Longitude") + ylab("Latitude") +
  ggtitle("log_effort manche_SCANS_III_summer") +
  facet_wrap(~ DCR_FLOTTILLE_LIB)



### Count the number of vessels per year per DCR_FLOTTILLE since Chalutiers pélagiques 
# aren't as spread out as the others

vessel_count <- data.frame()
unique_years <- unique(manche_campagnes$Year)

# Loop
for (year in unique_years) {
  
    manche_year <- manche_campagnes %>%
    filter(Year == year)
  
    counts <- manche_year %>%
    group_by(DCR_FLOTTILLE_LIB) %>%
    summarise(boat_count = n_distinct(NAVS_COD_YEAR))
  
    counts$Year <- year
  
  vessel_count <- bind_rows(vessel_count, counts)
}

print(vessel_count)

# Very few chalutiers pélagiques vessels (29,32,4,6 for each campagnes respectively) 
# Need to look at the overall data if the proportions are as drastic and if they aren't simply fishing at 
# Different times of the year. 

```

### Misc

```{r select_manche overview}

library(tidyr)

# % of activity per flottille per season 

## count of each flottille per season

byc_per_flottille <- select_manche %>%
  distinct(NAVS_COD_YEAR,.keep_all = TRUE) %>%
  group_by(Season, DCR_FLOTTILLE_LIB) %>%
  summarise(count = n()) %>%
  ungroup()

## total count of each flottille 
total_counts <- byc_per_flottille %>%
  group_by(DCR_FLOTTILLE_LIB) %>%
  summarise(total_count = sum(count))


## Merge the total counts back into the main dataframe
season_flottille <- left_join(byc_per_flottille, total_counts, by = "DCR_FLOTTILLE_LIB") %>%
  mutate(percentage = (count / total_count) * 100) %>%
  select(-count, -total_count) # Remove count and total_count columns

season_flottille <- season_flottille %>%
  pivot_wider(names_from = DCR_FLOTTILLE_LIB, values_from = percentage, values_fill = 0)


####

vessel_size <- select_manche %>%
  count(NAVP_LONGUEUR_HT, sort = TRUE) 

### Number of vessels per flottille per season 

vessel_nb <- select_manche %>%
  group_by(DCR_FLOTTILLE_LIB, Season)%>%
  distinct(NAVS_COD_YEAR) %>%
  summarise(vessel_number = n()) %>%
  arrange(vessel_number)

vessel_table <- vessel_nb %>%
  pivot_wider(names_from = DCR_FLOTTILLE_LIB, values_from = vessel_number, values_fill = 0)


# 



```

```{r manche_campagnes overview}


# % of activity per flottille per season 

## count of each flottille per season

byc_per_flottille <- manche_campagnes %>%
  distinct(NAVS_COD_YEAR,.keep_all = TRUE) %>%
  group_by(Season, DCR_FLOTTILLE_LIB) %>%
  summarise(count = n()) %>%
  ungroup()

## total count of each flottille 
total_counts <- byc_per_flottille %>%
  group_by(DCR_FLOTTILLE_LIB) %>%
  summarise(total_count = sum(count))


## Merge the total counts back into the main dataframe
season_flottille <- left_join(byc_per_flottille, total_counts, by = "DCR_FLOTTILLE_LIB") %>%
  mutate(percentage = (count / total_count) * 100) %>%
  select(-count, -total_count) # Remove count and total_count columns

season_flottille <- season_flottille %>%
  pivot_wider(names_from = DCR_FLOTTILLE_LIB, values_from = percentage, values_fill = 0)


####

vessel_size <- manche_campagnes %>%
  count(NAVP_LONGUEUR_HT, sort = TRUE) 

### Number of vessels per flottille per season 

vessel_nb <- manche_campagnes %>%
  group_by(DCR_FLOTTILLE_LIB, Season)%>%
  distinct(NAVS_COD_YEAR) %>%
  summarise(vessel_number = n()) %>%
  arrange(vessel_number)

vessel_table <- vessel_nb %>%
  pivot_wider(names_from = DCR_FLOTTILLE_LIB, values_from = vessel_number, values_fill = 0)




```



# Bycatch data

```{r }
 


####################################################################################

                        ########## SACROIS BYC ##########

 setwd("D:/Data")

library(data.table)
library(dplyr)
library(stringr)

DECL_BYC=data.table()

for (i in 2019:2023) {
  setwd(paste0('D:/Data/',i));
  DECL_BYC<-rbind(fread(paste0("CAPTURES-ACC-IFR_",i,".txt"), dec=",", encoding="Latin-1", colClasses=c("SECT_COD_SACROIS_NIV5"="character")), DECL_BYC, fill = T)
}
 
DECL_BYC <- DECL_BYC %>% 
  filter(SECT_COD_SACROIS_NIV3 %in% c("27.7.e", "27.7.d", "27.7.h") | 
           (SECT_COD_SACROIS_NIV3 == "27.7.h" & SECT_COD_SACROIS_NIV5 %in% c("27E3","27E4","26E4","26E3","25E3","25E4"))) %>%
  collect()


DECL_BYC$NAVS_COD_YEAR=paste(DECL_BYC[,NAVS_COD], str_sub(DECL_BYC[,AN]), sep="_")






####################################################################################

                        ########## OBSMER BYC ##########


setwd("D:/Data")
BYC <- read.table("sp_byc_3.csv", header = T, sep = ",")


BYC <- BYC %>% 
  filter(ZONE %in% c("27.7.e", "27.7.d", "27.7.h") | 
           (ZONE == "27.7.h" & RECTANGLE %in% c("27E3","27E4","26E4","26E3","25E3","25E4"))) %>%
  collect()
pipo <- BYC


pipo$LAT_DEB_OP <- as.numeric(pipo$LAT_DEB_OP)
pipo$LAT_FIN_OP <- as.numeric(pipo$LAT_FIN_OP)
pipo$LONG_DEB_OP <- as.numeric(pipo$LONG_DEB_OP)
pipo$LONG_FIN_OP <- as.numeric(pipo$LONG_FIN_OP)


pipo2 <- pipo %>% 
  mutate(mean_LAT = (LAT_DEB_OP + LAT_FIN_OP) / 2,
         mean_LONG = (LONG_DEB_OP + LONG_FIN_OP) / 2)

pipo2 <- pipo2 %>%
  left_join(FPC, by = c("NAVS_COD_YEAR" = "NAVS_COD_YEAR"))


pipo2$Season <- cut(sp_byc$Month, 
                            breaks = c(0, 3, 4, 8, 11, Inf), 
                            labels = c("Winter", "Spring", "Summer", "Fall", "Winter"),
                            include.lowest = TRUE)



points_byc <- data.frame(lon = pipo2$mean_LONG, lat = pipo2$mean_LAT, Espèce = pipo2$ESPECE, Month = pipo2$Month,Flottille= pipo2$DCR_FLOTTILLE_LIB)

points_byc_d <- points_byc %>% filter (Espèce %in% c("Delphinus delphis", "Phocoena phocoena")) 
points_byc_d <- na.omit(points_byc_d)

points_d_winter <- points_byc %>% filter (Species == "Delphinus delphis" & Month %in% c(11,12,1,2,3))
points_d_summer <- points_byc %>% filter (Species == "Delphinus delphis" & Month %in% c(4,5,6,7,8,9))

points <- st_as_sf(points_d_winter, coords = c("lon", "lat"), crs = 4326)
#points_d_summer <- st_as_sf(points_d_summer, coords = c("lon", "lat"), crs = 4326)

rect2 <- rect %>% filter(F_DIVISION %in% c("27.7.e", "27.7.d") | 
           (F_DIVISION == "27.7.h" & SECT_COD %in% c("27E3","27E4","26E4","26E3","25E3","25E4")))



rangex<-st_bbox(rect2)[c(1,3)]
rangey<-st_bbox(rect2)[c(1,3)]

#bycatch events = 5 total ind = 8


points_byc_dd <- points_byc_d %>%
  group_by(Flottille) %>%
  mutate(count = n()) %>%
  ungroup() %>%
  mutate(Flottille = reorder(Flottille, -count))



distinct_shapes <- c(18, 3, 6, 10, 8, 15)

# Add points with different shapes for each flottille and reorder the legend
h_byc <- h + 
  geom_point(data = points_byc_dd, aes(x = lon, y = lat, shape = Flottille, color = Espèce), size = 2) +
  scale_shape_manual(values = distinct_shapes[1:length(unique(points_byc_d$Flottille))]) +
  scale_color_manual(values = c("black", "red"))

 h_byc <- h_byc +   ggspatial::annotation_scale(location = "br", width_hint = 0.2, aes(style = "ticks")) + 
  ggspatial::annotation_north_arrow(location = "br", which_north = "true", height = unit(1, "cm"),
                                    width = unit(0.8, "cm"),pad_x = unit(0.1, "cm"), pad_y = unit(0.7, "cm"))
h_byc






#h_byc <- h + geom_point(data = points_byc_d, aes(x = lon, y = lat, shape = Flottille), color = "black", size = 1.5) +  scale_shape_manual(values = 1:length(unique(points_byc_d$Flottille)))


h_byc <- h_byc    + geom_point(data = filter(points_byc_d, Flottille == "Chalutiers de fond"), aes(x = lon, y = lat), shape = 16, color = "black", size = 3) 


h_byc <- h_byc + geom_point(data = filter(points_byc_d, Flottille == "Fileyeurs"), aes(x = lon, y = lat), shape = 17, color = "black", size = 3) 




peche <-basemap(limits = c(-8, 2.6, 47.9, 51.2), crs = 4326, grid.col = NA, land.col = "grey88", land.border.col = "black", land.size = 3) +
geom_sf(data = rect2, aes(geometry = geometry), fill = NA, color = "black") + # Set fill to white and color to black
geom_point(data = points_d_summer, aes(x = lon, y = lat), shape = 18, color = "red", size = 1.5) +
  geom_point() +
  theme(
    legend.position = "none", 
    legend.justification = c(1, 1))+
  coord_sf(xlim = rangex, ylim = rangey)+
  xlab("Longitude") + ylab("Latitude") +
  #facet_grid(~DCR_FLOTTILLE_LIB,labeller = labeller(DCR_FLOTTILLE_LIB = c("Fileyeurs" = "Trammel net","Chalutiers pélagiques" = "Midwater trawl", "Chalutiers de fond" = "Bottom trawl")))+
  ggtitle("Summer")
#limits = c(0.00005,0.5)

peche <- reorder_layers(peche)

peche <- peche +   ggspatial::annotation_scale(location = "br", width_hint = 0.2, aes(style = "ticks")) + 
  ggspatial::annotation_north_arrow(location = "br", which_north = "true", height = unit(1, "cm"),
                                    width = unit(0.8, "cm"),pad_x = unit(0.1, "cm"), pad_y = unit(0.7, "cm"))
peche

#ggsave("bycatch_summer.png", plot = peche, width = 6000, height = 4000, units = "px", dpi = 800, bg = "white")



```

### byc brouillon

```{r}
library(tidyr)




# Number of unspecified DCR_FLOTTILLE

#sp_byc <- sp_byc %>% filter( ESPECE %in% c("Delphinus delphis", "Phocoena phocoena")) 

NA_byc <- sum(is.na(sp_byc$DCR_FLOTTILLE_LIB)) / length(sp_byc$DCR_FLOTTILLE_LIB)

vessel_length <- sp_byc %>%
  count(ESPECE, NAVP_LONGUEUR_HT, sort = TRUE) 

#18% < 12m

# 66% of dolphin/porpoise byc has no DCR_FLOTTILLE specified 
# Same goes for specified boat length

byc_per_vessel <- sp_byc %>%
  group_by(ID_NAVIRE, ESPECE) %>%
  summarise(number_byc = n()) %>%
  arrange(number_byc)

byc_table <- byc_per_vessel %>%
  pivot_wider(names_from = ESPECE, values_from = number_byc, values_fill = 0)

# One vessel (chalut) has 11 byc of dolphins (2009,2011,2012), all during the winter (01, 02, 03)



byc_per_flottille <- sp_byc %>%
  group_by(DCR_FLOTTILLE_LIB, ESPECE) %>%
  summarise(number = n()) %>%
  arrange(number)

byc_flottille <- byc_per_flottille %>%
  pivot_wider(names_from = ESPECE, values_from = number, values_fill = 0)



#library(lubridate)


#sp_byc$DATE_FIN <- dmy_hms(sp_byc$DATE_FIN)
#sp_byc$Month <- month(sp_byc$DATE_FIN)
#sp_byc$Year <- year(sp_byc$DATE_FIN)

sp_byc$Season <- cut(sp_byc$Month, 
                            breaks = c(0, 3, 4, 8, 11, Inf), 
                            labels = c("Winter", "Spring", "Summer", "Fall", "Winter"),
                            include.lowest = TRUE)



## Proportion of bycatch per season

byc_per_flottille <- sp_byc %>%
  group_by(Season) %>%
  summarise(count = n()) %>%
  mutate(percentage = count / sum(count) * 100)



## Percentage of bycatch events per season for each species

byc_per_flottille <- sp_byc %>%
  group_by(Season, DCR_FLOTTILLE_LIB) %>%
  summarise(count = n()) %>%
  ungroup()

# Calculate the total count of each species
total_counts <- byc_per_flottille %>%
  group_by(DCR_FLOTTILLE_LIB) %>%
  summarise(total_count = sum(count))

# Merge the total counts back into the main dataframe
byc_per_flottille <- left_join(byc_per_flottille, total_counts, by = "DCR_FLOTTILLE_LIB") %>%
  mutate(percentage = (count / total_count) * 100) %>%
  select(-count, -total_count) # Remove count and total_count columns

byc_flottille <- byc_per_flottille %>%
  pivot_wider(names_from = DCR_FLOTTILLE_LIB, values_from = percentage, values_fill = 0)


#byc_sacrois_match <- sp_byc %>%
#  left_join(select_manche2, by = c("NAVS_COD_YEAR" = "NAVS_COD_YEAR"))



```

# Fishing effort, density, bycatch risk

## Megafauna

### Loading data

```{r Megafauna distribution data}

library(classInt)
library(dplyr)
library(sf)
library(ggplot2)
library(RColorBrewer)
library(data.table)
library(ggpubr) 

setwd("D:/Data")
megafauna <- read_sf("20240214_ModelMegafauneSAMM.gpkg") #This file contains dolphin, porpoise, and seabirds
#no seal info? cant find column breakdown in files

lon_min <- -9
lon_max <- 2
lat_min <- 47.5
lat_max <- 51.5

megafauna <- megafauna %>%
  filter(lon >= lon_min & lon <= lon_max & lat >= lat_min & lat <= lat_max)


ICES1 <- ICES %>%
  left_join(select(rect, SECT_COD,), by = c("statistic_rectangle" = "SECT_COD"))



# Load ICES polygon data
# Filter on the regions we want 

#setwd("D:/Data")
#ICES_data <- st_read("ICES_Areas_20160601_cut_dense_3857.shp")
#ICES_data <- ICES_data %>% filter(Area_Full %in% c("27.7.d", "27.7.e", "27.7.h")) %>%
#  select(Area_Full, geometry)
# Load megafauna data 
# Make sure coordinate system is the same as ICES_data

ICES1 <- st_as_sf(ICES1)
megafauna <- st_transform(megafauna, crs = st_crs(ICES1))

#st_crs = 4326


#intersection of megafauna polygons with ICES_data to have accurate area of coastal polygons

meg_polygons <- st_intersection(megafauna, ICES1)


meg_polygons$meg_area <- st_area(meg_polygons)
meg_polygons$meg_area <- as.numeric(meg_polygons$meg_area)
meg_polygons$meg_area <- meg_polygons$meg_area / 1e06

meg_polygons <- na.omit(meg_polygons)

# The intersection creates very very small and very very big but irrelevant polygons that aren't visible on the map
# We end up with either very very small or very very big values for density
# So to avoid having data skewed one way or another, we remove them :)

meg_polygons <- meg_polygons %>% filter (meg_area < 5.158303e+02 & meg_area >= 3 )


# meg_polygons$meg_area <- st_area(meg_polygons) <-- st_area gives me weird values, disregarding st_area for the time being
#i'll use the area of the megafauna dataset (pelagis) later on to adjust fishing effort



# Grabbing dolphin density (#/km2)

meg_polygons$density <- meg_polygons$abund / meg_polygons$meg_area
#meg_polygons$log_density <- log(meg_polygons$density)

# putting density in log for better visualization

# testing other ways to normalize data for better visualization
# this did not work (uniform color on map), the min max normalization did not have better results either

#meg_polygons$normalized_density <- scale(meg_polygons$density, 
                                         #center = min(meg_polygons$density), 
                                         #scale = max(meg_polygons$density) - min(meg_polygons$density))

#meg_polygons$normalized_density <- scale(meg_polygons$density)



```



### Distribution

#### Delphinus delphis Distribution

```{r DELDEL}

# Maps : Delphinus delphis distribution

dauphin <- meg_polygons %>% filter(taxon %in% "DELDEL")

dauphin_summer<- dauphin %>%
  filter(session_global %in% c("SAMM_1_summer", "SCANS_3_summer"))


dauphin_winter <- dauphin %>%
  filter(session_global%in% c("SAMM_1_winter", "SAMM_2_winter"))



#classes <- classIntervals(dd_dist$abund, n = 6, style = "quantile")
#dd_dist <- dd_dist %>%
#  mutate(percent_class = cut(abund, classes$brks, include.lowest = T))
#dd_dist <- dd_dist %>% select (taxon,abund, percent_class,season, geom)%>%st_as_sf()


#dd_dist$abund_normalized <- scale(dd_dist$abund, center = min(dd_dist$abund), scale = max(dd_dist$abund) - min(dd_dist$abund))

#dd_dist$log_abund <- log(dd_dist$abund)

#get the limx and limy for coord_sf

library(ggOceanMaps)

rangex<-st_bbox(dauphin_summer)[c(1,3)]
rangey<-st_bbox(dauphin_summer)[c(2,4)]

unit <- expression(log("ind/km"^2))

# Summer

dd_abund <- 
  basemap(limits = c(-10, 3, 48, 51.5),crs = 4326, grid.col = NA) +
  geom_sf(data = dauphin_summer, aes(fill = density))+
  scale_fill_distiller(palette='Spectral',name=unit, trans = "log10",limits = c(0.001, 1))+
  coord_sf(rangex, rangey) +
  theme_bw(base_size = 20)+
  xlab("Longitude") + ylab("Latitude") +
  ggtitle("C.")

dd_abund <- reorder_layers(dd_abund)
dd_abund <- dd_abund +   ggspatial::annotation_scale(location = "br", width_hint = 0.2) + 
  ggspatial::annotation_north_arrow(location = "br", which_north = "true", height = unit(1, "cm"),
                                    width = unit(0.8, "cm"),pad_x = unit(0.1, "cm"), pad_y = unit(0.7, "cm"))
  #theme(legend.position = "bottom")  # Adjusting legend position
dd_abund

ggsave("m_density_summer.png", plot = dd_abund, width = 6000, height = 4000, units = "px", dpi = 600, bg = "white")


# Winter

dd_abund2 <- 
  basemap(limits = c(-10, 3, 48, 51.5),crs = 4326, grid.col = NA) +
  geom_sf(data = dauphin_winter, aes(fill = density))+
  scale_fill_distiller(palette='Spectral',name= unit, trans = "log10", limits = c(0.001, 1))+
    guides(fill="none") + 
  coord_sf(rangex, rangey) +
  theme_bw(base_size = 20)+
  xlab("Longitude") + ylab("Latitude") +
  ggtitle("D.")

dd_abund2 <- reorder_layers(dd_abund2)
dd_abund2 <- dd_abund2 +   ggspatial::annotation_scale(location = "br", width_hint = 0.2) + 
  ggspatial::annotation_north_arrow(location = "br", which_north = "true", height = unit(1, "cm"),
                                    width = unit(0.8, "cm"),pad_x = unit(0.1, "cm"), pad_y = unit(0.7, "cm"))
  #theme(legend.position = "bottom")  # Adjusting legend position
dd_abund2



abund_map <- plot_grid(dd_abund, dd_abund2, ncol = 1, align = "v", axis = "tblr", rel_widths = c(1, 1.3))
abund_map


ggsave("m_density_maps_final.png", plot = abund_map, width = 5000, height = 4000, units = "px", dpi = 600, bg = "white")

```

#### Phocoena phocoena distribution

```{r marsouin distribution}

# Maps : Phocoena phocoena distribution

#pp_dist <- meg_polygons %>%
#  filter(taxon %in% "PHOPHO")
#pp_dist <- na.omit(pp_dist)

marsouin <- meg_polygons %>% filter(taxon %in% "PHOPHO")

m_summer<- marsouin %>%
  filter(session_global %in% c("SAMM_1_summer", "SCANS_3_summer"))


m_winter <- marsouin %>%
  filter(session_global%in% c("SAMM_1_winter", "SAMM_2_winter"))

pp_points <- points_byc %>% filter (Species == "Phocoena phocoena")

#get the limx and limy for coord_sf
rangex<-st_bbox(pp_dist)[c(1,3)]
rangey<-st_bbox(pp_dist)[c(2,4)]


########################## basemap
pp_abund <- 
  basemap(limits = c(-10, 3, 48, 51.5),crs = 4326, grid.col = NA) +
  geom_sf(data = m_summer, aes(fill = density))+
  scale_fill_distiller(palette='Spectral',name="Value (unit)", trans = "log10")+
  coord_sf(rangex, rangey) +
  xlab("Longitude") + ylab("Latitude") +
  ggtitle("Delphinus delphis abundance")

pp_abund <- reorder_layers(pp_abund)
pp_abund <- pp_abund +   ggspatial::annotation_scale(location = "br", width_hint = 0.2) + 
  ggspatial::annotation_north_arrow(location = "br", which_north = "true", height = unit(1, "cm"),
                                    width = unit(0.8, "cm"),pad_x = unit(0.1, "cm"), pad_y = unit(0.7, "cm"))
  #theme(legend.position = "bottom")  # Adjusting legend position
pp_abund


pp_abund <- 
  basemap(limits = c(-10, 3, 48, 51.5),crs = 4326, grid.col = NA) +
  geom_sf(data = m_winter, aes(fill = density))+
  scale_fill_distiller(palette='Spectral',name="Value (unit)", trans = "log10")+
  coord_sf(rangex, rangey) +
  xlab("Longitude") + ylab("Latitude") +
  ggtitle("Delphinus delphis abundance")

pp_abund <- reorder_layers(pp_abund)
pp_abund <- pp_abund +   ggspatial::annotation_scale(location = "br", width_hint = 0.2) + 
  ggspatial::annotation_north_arrow(location = "br", which_north = "true", height = unit(1, "cm"),
                                    width = unit(0.8, "cm"),pad_x = unit(0.1, "cm"), pad_y = unit(0.7, "cm"))
  #theme(legend.position = "bottom")  # Adjusting legend position
pp_abund






####################################### borders
 pp_abund <-ggplot() + 
  theme_bw()+
  geom_sf(data = pp_dist, aes(fill = abund))+
  scale_color_manual(values = "black") + 
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)", trans = "log10")+
  #scale_fill_manual(values = brewer.pal(n = length(unique(meg$percent_class)), name = 'Spectral'),
                    #name = "#") +  
  coord_sf(rangex, rangey) +
  xlab("Longitude") + ylab("Latitude") +
  ggtitle("Phocoena phocoena abundance")+
  facet_wrap(~ session_global)
pp_abund


 pp_density <-ggplot() + 
  theme_bw()+
  geom_sf(data = pp_dist, aes(fill = density))+
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)", trans = "log10")+
  #scale_fill_manual(values = brewer.pal(n = length(unique(meg$percent_class)), name = 'Spectral'),
                    #name = "#") +  
  coord_sf(rangex, rangey) +
  xlab("Longitude") + ylab("Latitude") +
  ggtitle("Phocoena phocoena density")+
  facet_wrap(~ session_global)
pp_density


```


### Bycatch risk maps

#### Delphinus delphis

```{r dd risk / campagnes}


# ONLY NEED TO CHANGE THE TAXON 

dauphin <- meg_polygons %>% filter(taxon %in% "DELDEL")

# breaking down everything per season so st_intersection matches and doesn't take forever

dauphin_SAMM_I_summer <- dauphin %>%
  filter(session_global == "SAMM_1_summer")
dauphin_SAMM_I_winter <- dauphin %>%
  filter(session_global == "SAMM_1_winter")
dauphin_SAMM_II_winter <- dauphin %>%
  filter(session_global == "SAMM_2_winter")
dauphin_SCANS_III_summer <- dauphin %>%
  filter(session_global == "SCANS_3_summer")


# Converting coordinate systems
# matching the each data set with its corresponding season wasn't necessary but it was done anyways

effort_SAMM_I_summer <- st_transform(effort_SAMM_I_summer, crs = st_crs(dauphin_SAMM_I_summer))
effort_SAMM_I_winter <- st_transform(effort_SAMM_I_winter, crs = st_crs(dauphin_SAMM_I_summer))
effort_SAMM_II_winter <- st_transform(effort_SAMM_II_winter, crs = st_crs(dauphin_SAMM_I_summer))
effort_SCANS_III_summer <- st_transform(effort_SCANS_III_summer, crs = st_crs(dauphin_SAMM_I_summer))

# Intersecting each fishing effort per survey season with dolphin data per survey season


SAMM_I_summer <- st_intersection(effort_SAMM_I_summer, dauphin_SAMM_I_summer)
SAMM_I_winter <- st_intersection(effort_SAMM_I_winter, dauphin_SAMM_I_winter)
SAMM_II_winter <- st_intersection(effort_SAMM_II_winter, dauphin_SAMM_II_winter)
SCANS_III_summer <- st_intersection(effort_SCANS_III_summer, dauphin_SCANS_III_summer)


# Grabbing the area
# This gives me erroneous areas, i'm letting it run in the code but i'm disregarding it for now

SAMM_I_summer$new_area <- st_area(SAMM_I_summer)
SAMM_I_summer$new_area <- (as.numeric(SAMM_I_summer$new_area)) / 1e06


SAMM_I_winter$new_area <- st_area(SAMM_I_winter)
SAMM_I_winter$new_area <- (as.numeric(SAMM_I_winter$new_area)) / 1e06

SAMM_II_winter$new_area <- st_area(SAMM_II_winter)
SAMM_II_winter$new_area <- (as.numeric(SAMM_II_winter$new_area)) / 1e06

SCANS_III_summer$new_area <- st_area(SCANS_III_summer)
SCANS_III_summer$new_area <- (as.numeric(SCANS_III_summer$new_area)) / 1e06




# For now I've only taken the un-adjusted fishing_effort (meaning, not adjusted with statistic-rectangle area) due
# to the fact the code wasn't working 
# This gives us hours fished/m2


# Now i'm adjusting effort according to area (Pelagis grid) hrs/km2
SAMM_I_summer$adjusted_effort <- SAMM_I_summer$hrs_km2 * SAMM_I_summer$new_area


SAMM_I_winter$adjusted_effort <- SAMM_I_winter$hrs_km2 * SAMM_I_winter$new_area

SAMM_II_winter$adjusted_effort <- SAMM_II_winter$hrs_km2 * SAMM_II_winter$new_area

SCANS_III_summer$adjusted_effort <- SCANS_III_summer$hrs_km2 * SCANS_III_summer$new_area




#SAMM_I_summer$density <- SAMM_I_summer$abund / SAMM_I_summer$new_area
#SAMM_I_winter$density <- SAMM_I_winter$abund / SAMM_I_winter$new_area
#SAMM_II_winter$density <- SAMM_II_winter$abund / SAMM_II_winter$new_area
#SCANS_III_summer$density <- SCANS_III_summer$abund / SCANS_III_summer$new_area


# However, OFB puts fish hours and dolphin density in log? and then does the risk index?
# "L’indice de risque d’exposition est calculé suivant la formule suivante : DENSITE (ind/km2) x EFFORT DE PECHE (heures/mailles). Les deux paramètres (densités et efforts de pêches) sont log-normalisés vis-à-vis de la valeur maximale"
# The thing is if I do that, assuming the norm_minmax function is what OFB is talking about, the risk map looks really lame 

  ## Doing it for one season, found risk effort and mapped it (further down below)

norm_minmax <- function(x){
  (x- min(x)) /(max(x)-min(x))
}

#SAMM_I_summer <- SAMM_I_summer[complete.cases(SAMM_I_summer$adjusted_effort), ]
#SAMM_I_summer <- SAMM_I_summer[complete.cases(SAMM_I_summer$density), ]

#SAMM_I_summer$normalized_effort <- norm_minmax(SAMM_I_summer$adjusted_effort)
#SAMM_I_summer$normalized_density <- norm_minmax(SAMM_I_summer$density)



# Risk index


SAMM_I_summer$risk_index <- SAMM_I_summer$adjusted_effort * SAMM_I_summer$density
#SAMM_I_summer$log_risk_index <- log(SAMM_I_summer$adjusted_effort * SAMM_I_summer$density)
#SAMM_I_summer$norm_risk <- SAMM_I_summer$normalized_effort * SAMM_I_summer$normalized_density
#SAMM_I_summer$ <- SAMM_I_summer$ * SAMM_I_summer$normalized_density


SAMM_I_winter$risk_index <- SAMM_I_winter$adjusted_effort * SAMM_I_winter$density
#SAMM_I_winter$log_risk_index <- log(SAMM_I_winter$adjusted_effort * SAMM_I_winter$density)


SAMM_II_winter$risk_index <- SAMM_II_winter$adjusted_effort * SAMM_II_winter$density
#SAMM_II_winter$log_risk_index <- log(SAMM_II_winter$adjusted_effort * SAMM_II_winter$density)
#SAMM_II_winter$log_risk_index <- log(SAMM_II_winter$adjusted_effort * SAMM_II_winter$density)


SCANS_III_summer$risk_index <- SCANS_III_summer$adjusted_effort * SCANS_III_summer$density
#SCANS_III_summer$normalized_risk_index <- scale(SCANS_III_summer$adjusted_effort * SCANS_III_summer$density)
#SCANS_III_summer$log_risk_index <- log(SCANS_III_summer$adjusted_effort * SCANS_III_summer$density)
#SCANS_III_summer$risk_index <- SCANS_III_summer$log_effort * SCANS_III_summer$log_density


SAMM_I_summer <- SAMM_I_summer %>% filter (new_area < 5.158303e+02 & new_area >= 3 )
SAMM_I_winter <- SAMM_I_winter %>% filter (new_area < 5.158303e+02 & new_area >= 3 )
SAMM_II_winter <- SAMM_II_winter %>% filter (new_area < 5.158303e+02 & new_area >= 3 )
SCANS_III_summer <- SCANS_III_summer %>% filter (new_area < 5.158303e+02 & new_area >= 3 )

```

##### winter & summer

```{r risk / season}



# ONLY NEED TO CHANGE TAXON

dauphin <- meg_polygons %>% filter(taxon %in% "DELDEL")

# breaking down everything per season so st_intersection matches and doesn't take forever

dauphin_summer<- dauphin %>%
  filter(session_global %in% c("SAMM_1_summer", "SCANS_3_summer"))


dauphin_winter <- dauphin %>%
  filter(session_global%in% c("SAMM_1_winter", "SAMM_2_winter"))


fish_summer <- st_as_sf(fish_summer)
fish_winter <- st_as_sf(fish_winter)

# Converting coordinate systems
# matching the each data set with its corresponding season wasn't necessary but it was done anyways

fish_summer <- st_transform(fish_summer, crs = st_crs(dauphin_summer))
fish_winter <- st_transform(fish_winter, crs = st_crs(dauphin_winter))

# Intersecting each fishing effort per survey season with dolphin data per survey season

summer_risk <- st_intersection(fish_summer, dauphin_summer)
winter_risk <- st_intersection(fish_winter, dauphin_winter)


sf_use_s2(FALSE)

# Grabbing the area
# This gives me erroneous areas, i'm letting it run in the code but i'm disregarding it for now

summer_risk$new_area <- st_area(summer_risk)
summer_risk$new_area <- (as.numeric(summer_risk$new_area)) / 1e06


winter_risk$new_area <- st_area(winter_risk)
winter_risk$new_area <- (as.numeric(winter_risk$new_area)) / 1e06


# Now i'm adjusting effort according to area (Pelagis grid) hrs/km2

summer_risk$adjusted_effort <- summer_risk$hrs_km2 * summer_risk$new_area
winter_risk$adjusted_effort <- winter_risk$hrs_km2 * winter_risk$new_area

# Sp density

#summer_risk$density <- summer_risk$abund / summer_risk$new_area
#winter_risk$density <- winter_risk$abund / winter_risk$new_area


# Risk index


summer_risk$risk_index <- summer_risk$adjusted_effort * summer_risk$density

winter_risk$risk_index <- winter_risk$adjusted_effort * winter_risk$density

summer_risk <- summer_risk %>% filter (new_area < 5.158303e+02 & new_area >= 3 )
winter_risk <- winter_risk %>% filter (new_area < 5.158303e+02 & new_area >= 3 )


```


##### Borders

```{r borders}
#Chalutiers de fond
#Fileyeurs
#Chalutiers pélagiques

rangex<-st_bbox(winter_risk)[c(1,3)]
rangey<-st_bbox(winter_risk)[c(2,4)]

unit <- expression(log(ind/km^2))


summer_map <- ggplot() + 
  theme_bw() +
  geom_sf(data = winter_risk, aes(fill = adjusted_effort)) +
  geom_point(data = filter(points_d_summer, Flottille == "Fileyeurs"), aes(x = lon, y = lat, color=Species), shape = 18, size = 2) +
  scale_color_manual(values = "black") + 
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name= "log(heures)", trans = "log10")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
    facet_wrap(~DCR_FLOTTILLE_LIB)+
ggtitle("Effort de pêche des chalutiers de fond - hiver")+
  annotation_scale(location = "br", width_hint = 0.2, aes(style = "ticks")) +
  annotation_north_arrow(location = "br", which_north = "true", height = unit(1, "cm"), width = unit(0.8, "cm"),pad_x = unit(0.1, "cm"), pad_y = unit(0.7, "cm"), style = north_arrow_orienteering)
summer_map

summer_map + 
  annotation_scale(location = "bl") +  # Adjust the location as needed
  annotation_north_arrow(location = "tl", which_north = "true")






winter_map <- ggplot() + 
  theme_bw() +
  geom_sf(data = filter(winter_risk, DCR_FLOTTILLE_LIB == "Fileyeurs"), aes(fill = risk_index )) +
  borders("world", fill = "light grey", colour = "light grey") +
  geom_point(data = filter(points_d_winter, Flottille == "Fileyeurs"), aes(x = lon, y = lat, color=Species), shape = 18, size = 2) +
  scale_color_manual(values = "black") +  # Manually setting color to black
  scale_fill_distiller(palette='Spectral',name= "log(hours*ind/km2)", trans = "log10")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)+
ggtitle("Phocoena phocoena bycatch risk distribution (fileyeurs) - Winter")+
  annotation_scale(location = "br", width_hint = 0.2) +
    annotation_north_arrow(location = "br", which_north = "true", height = unit(1, "cm"), width = unit(0.8, "cm"),pad_x = unit(0.1, "cm"), pad_y = unit(0.7, "cm"),
        style = north_arrow_orienteering)
winter_map



#ggsave("chalut_fond_effort_hiver.png", plot = summer_map, width = 10, height = 8, units = "in", dpi = 300)
#ggsave("winter_map_chalut_pelagique_byc.png", plot = winter_map, width = 10, height = 8, units = "in", dpi = 300)

```

##### Basemap 

```{r}

#Chalutiers de fond
#Fileyeurs
#Chalutiers pélagiques


#unit <- expression(log(hours)) # Fishing effort 

#unit <- expression(log("ind/km"^2)) # Density distribution

unit <- expression(log(hours * "*ind/km"^2)) # Risk index

#get the limx and limy for coord_sf
rangex<-st_bbox(fish_effort)[c(1,3)]
rangey<-st_bbox(fish_effort)[c(2,4)]
limits = c(1E-06, 270)

# marsouins : fileyeurs = c(0.001, 32)
# dauphins : fileyeurs, fond, pelagique = c(1E-06, 270)


fileyeur <- basemap(limits = c(-8, 2.6, 47.9, 51.2),crs = 4326, grid.col = NA,land.col = "grey88", land.border.col = "black", land.size = 3) +
  geom_sf(data = filter(summer_risk, DCR_FLOTTILLE_LIB == "Fileyeurs"), aes(fill = risk_index)) +
  scale_fill_distiller(palette = "Spectral", name= unit, trans = "log10", limits = limits)+
  theme(
    legend.position = "right", 
    legend.justification = c(1, 1))+
  guides(fill="none") + 
  coord_sf(xlim = rangex, ylim = rangey)+
  theme_bw(base_size = 10)+
  xlab("Longitude") + ylab("Latitude")+
  ggtitle("A.")
  #ggtitle("Fileyeurs")
#limits = c(0.00005,0.5)

fileyeur <- reorder_layers(fileyeur)

fileyeur <- fileyeur +   ggspatial::annotation_scale(location = "br", width_hint = 0.2, aes(style = "ticks")) + 
  ggspatial::annotation_north_arrow(location = "br", which_north = "true", height = unit(1, "cm"),
                                    width = unit(0.8, "cm"),pad_x = unit(0.1, "cm"), pad_y = unit(0.7, "cm"))
fileyeur


#ggsave("h_f.png", plot = fileyeur, width = 6000, height = 4000, units = "px", dpi = 600, bg = "white")




#### fond 

fond <- basemap(limits = c(-8, 2.6, 47.9, 51.2),crs = 4326, grid.col = NA,land.col = "grey88", land.border.col = "black", land.size = 3) +
  geom_sf(data = filter(summer_risk, DCR_FLOTTILLE_LIB == "Chalutiers de fond"), aes(fill = risk_index)) +
  scale_fill_distiller(palette = "Spectral", name= unit, trans = "log10", limits = limits)+
  theme(
    legend.position = "right", 
    legend.justification = c(1, 1))+
  #guides(fill="none") + 
  coord_sf(xlim = rangex, ylim = rangey)+
  theme_bw(base_size = 10)+
  xlab("Longitude") + ylab("Latitude")+
  ggtitle("B.")
  #ggtitle("Chalutiers de fond")
#limits = c(0.00005,0.5)

fond <- reorder_layers(fond)

fond <- fond +   ggspatial::annotation_scale(location = "br", width_hint = 0.2, aes(style = "ticks")) + 
  ggspatial::annotation_north_arrow(location = "br", which_north = "true", height = unit(1, "cm"),
                                    width = unit(0.8, "cm"),pad_x = unit(0.1, "cm"), pad_y = unit(0.7, "cm"))
fond


#ggsave("d_winter_summer_density.png", plot = maps, width = 6000, height = 4000, units = "px", dpi = 600, bg = "white")


#maps <- plot_grid(fileyeur, fond, ncol = 1, align = "v", axis = "tblr", rel_widths = c(1, 1.3))
#maps

#ggsave("marsouin_ete_hiver_fileyeurs_risk.png", plot = maps, width = 4000, height = 3500, units = "px", dpi = 600, bg = "white")


### pelagique 


pelagique <- basemap(limits = c(-8, 2.6, 47.9, 51.2),crs = 4326, grid.col = NA,land.col = "grey88", land.border.col = "black", land.size = 3) +
  geom_sf(data = filter(summer_risk, DCR_FLOTTILLE_LIB == "Chalutiers pélagiques"),aes(fill = risk_index)) +
  scale_fill_distiller(palette = "Spectral", name= unit, trans = "log10", limits = limits)+
  theme(
    legend.position = "right", 
    legend.justification = c(1, 1))+
  guides(fill="none") +
  coord_sf(xlim = rangex, ylim = rangey)+
  theme_bw(base_size = 10)+
  xlab("Longitude") + ylab("Latitude")+
  ggtitle("C.")

  #ggtitle("Chalutiers pélagiques")
#limits = c(0.00005,0.5)

pelagique <- reorder_layers(pelagique)

pelagique <- pelagique +   ggspatial::annotation_scale(location = "br", width_hint = 0.2, aes(style = "ticks")) + 
  ggspatial::annotation_north_arrow(location = "br", which_north = "true", height = unit(1, "cm"),
                                    width = unit(0.8, "cm"),pad_x = unit(0.1, "cm"), pad_y = unit(0.7, "cm"))
pelagique


maps <- plot_grid(fileyeur, fond, pelagique, ncol = 1, align = "v", axis = "tblr", rel_widths = c(1, 1.3))
maps

```



#####ICES map

```{r ICES map}

# ICES division map 

setwd("D:/Data")
ICES_1 <- readRDS("allgeo.rds")
ICES_1 <- ICES_1 %>% filter (icesdiv %in% c("27.7.h", "27.7.e", "27.7.d")) %>% filter (type == "ices_rectangle")

ICES1 <- subset(ICES_1, !(offname %in% c("24E4", "24E5", "28E1", "28E2", "27E1", "27E2", "26E1", "26E2", "25E1", "25E2")))

H <- data.frame(label = "FRANCE", lon = 0, lat = 48.5)
E <- data.frame(label = "ANGLETERRE", lon = -1.5, lat = 51.2)
D <- data.frame(label = "27.7.d", lon = 0, lat = 50)

cols = c("lightskyblue1", "lightskyblue2", "lightskyblue3")

h <- basemap(limits = c(-8, 3, 47.8, 51.5),crs = 4326, grid.col = NA,land.col = "grey88",) + 
  geom_sf(data = filter(ICES1, icesdiv %in% c("27.7.h", "27.7.e", "27.7.d")), aes(fill = icesdiv), color = "grey", alpha = 0.5)+
  #guides(fill="none")
  #geom_label(data = D, aes(label = label, x = lon, y = lat), 
  #           size = 4, color = "black", fill = "white", label.padding = unit(0.2, "lines"),
  #           label.r = unit(0.1, "lines"), label.size = NA) +  borders("world", fill = "grey88", 
                                                                      # colour = "grey88") +

  
  #scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  #scale_fill_manual(values = brewer.pal(n = length(unique(ICES1$`ICES division`)), name = 'GnBu'), name = "#") +  
  scale_fill_manual(values = cols, name = "Division CIEM")+
  coord_sf(rangex, rangey) +
  xlab("Longitude") + ylab("Latitude") 
  #ggtitle("English Channel ICES divisions")


h <- reorder_layers(h)

h <- h +
  geom_text(data = H, aes(label = label, x = lon, y = lat), 
            size = 4, color = "black") +
  geom_text(data = E, aes(label = label, x = lon, y = lat), 
            size = 4, color = "black")
  
  
  
  
  geom_label(data = H, aes(label = label, x = lon, y = lat), 
             size = 4, color = "black", fill = "white", label.padding = unit(0, "lines"), label.r = unit(0, "lines"), label.size = NA) +  
  geom_label(data = E, aes(label = label, x = lon, y = lat), 
             size = 4, color = "black", fill = "white", label.padding = unit(0, "lines"), label.r = unit(0, "lines"), label.size = NA)
h


```


##### risk maps per campagnes


```{R Risk maps}


rangex<-st_bbox(SAMM_I_summer)[c(1,3)]
rangey<-st_bbox(SAMM_I_summer)[c(2,4)]

# Remove # in front of facet_wrap to see risk per DCR_flottille (Fileyeurs, chalutiers de fond, chalutiers pélagiques)
# There is an issue however when looking at specific flottille, can't figure out why the borders don't show up

    # SAMM_I_summer map (a) is currently coded for normalized risk, not log risk
a <- ggplot() + 
  theme_bw() +
  geom_sf(data = SAMM_I_summer, aes(fill = risk_index )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)", trans = "log10")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  facet_wrap(~DCR_FLOTTILLE_LIB)+
ggtitle("SAMM_I_summer log_risk_index")
a


b <- ggplot() + 
  theme_bw() +
  geom_sf(data = SAMM_I_winter, aes(fill = risk_index )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)", trans = "log10")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  facet_wrap(~DCR_FLOTTILLE_LIB)+
ggtitle("SAMM_I_winter log_risk_index")
b

c <- ggplot() + 
  theme_bw() +
  geom_sf(data = SAMM_II_winter, aes(fill = risk_index )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)", trans = "log10")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  facet_wrap(~DCR_FLOTTILLE_LIB)+
ggtitle("SAMM_II_winter log_risk_index")
c

d <- ggplot() + 
  theme_bw() +
  geom_sf(data = SCANS_III_summer, aes(fill = risk_index )) +
  scale_fill_distiller(palette='Spectral',name="Value (unit)", trans = "log10")+
  coord_sf(xlim = rangex, ylim = rangey) +
  borders("world", fill = "light grey", colour = "light grey") +
  xlab("Longitude") + ylab("Latitude") +
  facet_wrap(~DCR_FLOTTILLE_LIB)+
ggtitle("SCANS_III_summer log_risk_index")
d

ggarrange(a,b,c,d, labels = "Delphinus delphis log(risk_index)/season")


#### mapping stuff 
#plot(risk_polygons$geom, col = 'lightblue')
#plot(megafauna$geom, col = "pink")




```

##### + Maps of log(density, effort, risk) / season

```{r more maps}

# Remove # in front of facet_wrap to see risk per DCR_flottille (Fileyeurs, chalutiers de fond, chalutiers pélagiques)
# There is an issue however when looking at specific flottille, can't figure out why the borders don't show up

# Load necessary packages
library(tidyverse)
library(ggrepel)
library(sf)
library(marmap)


# SAMM_I_summer

a1 <- ggplot() + 
  theme_bw() +
  geom_sf(data = SAMM_I_summer, aes(fill = density )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="log(ind/km2)", trans = "log10")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("Delphinus delphis density")+
  annotation_scale(location = "bl", width_hint = 0.2) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.0, "in"), pad_y = unit(0.2, "in"),
        style = north_arrow_fancy_orienteering)


a2 <- ggplot() + 
  theme_bw() +
  geom_sf(data = SAMM_I_summer, aes(fill = adjusted_effort )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="log(hours)", trans = "log10")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("Fishing effort")+
  annotation_scale(location = "bl", width_hint = 0.2) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.0, "in"), pad_y = unit(0.2, "in"),
        style = north_arrow_fancy_orienteering)


a3 <- ggplot() + 
  theme_bw() +
  geom_sf(data = SAMM_I_summer, aes(fill = risk_index )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="log(hrs*ind/km2)", trans = "log10")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("Bycatch risk index")+
  annotation_scale(location = "bl", width_hint = 0.2) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.0, "in"), pad_y = unit(0.2, "in"),
        style = north_arrow_fancy_orienteering)

ggarrange(a1,a2,a3, labels = "Delphinus delphis bycatch risk index summary - Summer (2012)")

#####################################################################

# SAMM_I_winter

b1 <- ggplot() + 
  theme_bw() +
  geom_sf(data = SAMM_I_winter, aes(fill = density )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="log(ind/km2)", trans = "log10")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("Delphinus delphis density")+
  annotation_scale(location = "bl", width_hint = 0.2) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.0, "in"), pad_y = unit(0.2, "in"),
        style = north_arrow_fancy_orienteering)


b2 <- ggplot() + 
  theme_bw() +
  geom_sf(data = SAMM_I_winter, aes(fill = adjusted_effort )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="log(hours)", trans = "log10")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("Fishing effort")+
  annotation_scale(location = "bl", width_hint = 0.2) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.0, "in"), pad_y = unit(0.2, "in"),
        style = north_arrow_fancy_orienteering)


b3 <- ggplot() + 
  theme_bw() +
  geom_sf(data = SAMM_I_winter, aes(fill = risk_index )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="log(hrs*ind/km2)", trans = "log10")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("Bycatch risk index")+
  annotation_scale(location = "bl", width_hint = 0.2) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.0, "in"), pad_y = unit(0.2, "in"),
        style = north_arrow_fancy_orienteering)

ggarrange(b1,b2,b3, labels = "Delphinus delphis bycatch risk index summary - Winter (2011-2012)")


#####################################################################


# SAMM_II_winter

c1 <- ggplot() + 
  theme_bw() +
  geom_sf(data = SAMM_II_winter, aes(fill = density )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="log(ind/km2)", trans = "log10")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("Delphinus delphis density")+
  annotation_scale(location = "bl", width_hint = 0.2) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.0, "in"), pad_y = unit(0.2, "in"),
        style = north_arrow_fancy_orienteering)


c2 <- ggplot() + 
  theme_bw() +
  geom_sf(data = SAMM_II_winter, aes(fill = adjusted_effort )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="log(hours)", trans = "log10")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("Fishing effort")+
  annotation_scale(location = "bl", width_hint = 0.2) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.0, "in"), pad_y = unit(0.2, "in"),
        style = north_arrow_fancy_orienteering)


c3 <- ggplot() + 
  theme_bw() +
  geom_sf(data = SAMM_II_winter, aes(fill = risk_index )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="log(hrs*ind/km2)", trans = "log10")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("Bycatch risk index")+
  annotation_scale(location = "bl", width_hint = 0.2) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.0, "in"), pad_y = unit(0.2, "in"),
        style = north_arrow_fancy_orienteering)

ggarrange(c1,c2,c3, labels = "Delphinus delphis bycatch risk index summary - Winter (2021)")


#####################################################################

# SCANS_III_summer

d1 <- ggplot() + 
  theme_bw() +
  geom_sf(data = SCANS_III_summer, aes(fill = density )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="log(ind/km2)", trans = "log10")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("Delphinus delphis density")+
  annotation_scale(location = "bl", width_hint = 0.2) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.0, "in"), pad_y = unit(0.2, "in"),
        style = north_arrow_fancy_orienteering)


d2 <- ggplot() + 
  theme_bw() +
  geom_sf(data = SCANS_III_summer, aes(fill = adjusted_effort )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="log(hours)", trans = "log10")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("Fishing effort")+
  annotation_scale(location = "bl", width_hint = 0.2) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.0, "in"), pad_y = unit(0.2, "in"),
        style = north_arrow_fancy_orienteering)


d3 <- ggplot() + 
  theme_bw() +
  geom_sf(data = SCANS_III_summer, aes(fill = risk_index )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="log(hrs*ind/km2)", trans = "log10")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("Bycatch risk index")+
  annotation_scale(location = "bl", width_hint = 0.2) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.0, "in"), pad_y = unit(0.2, "in"),
        style = north_arrow_fancy_orienteering)

ggarrange(d1,d2,d3, labels = "Delphinus delphis bycatch risk index summary - Summer (2016)")


arrange <- ggarrange(a1,a2,a3,b1,b2,b3,c1,c2,c3,d1,d2,d3)

ggsave(filename=Documents,
       plot=c1, 
       device="png")

```

### Phocoena phocoena

```{r marsouins}

# Remove # in front of facet_wrap to see risk per DCR_flottille (Fileyeurs, chalutiers de fond, chalutiers pélagiques)
# There is an issue however when looking at specific flottille, can't figure out why the borders don't show up


marsouin <- meg_polygons %>% filter(taxon %in% "PHOPHO")


marsouin_SAMM_I_summer <- marsouin %>%
  filter(session_global == "SAMM_1_summer")
marsouin_SAMM_I_winter <- marsouin %>%
  filter(session_global == "SAMM_1_winter")
marsouin_SAMM_II_winter <- marsouin %>%
  filter(session_global == "SAMM_2_winter")
marsouin_SCANS_III_summer <- marsouin %>%
  filter(session_global == "SCANS_3_summer")


# Converting coordinate systems
# Intersecting each fishing effort per survey season with dolphin data per survey season

effort_SAMM_I_summer <- st_transform(effort_SAMM_I_summer, crs = st_crs(marsouin_SAMM_I_summer))
effort_SAMM_I_winter <- st_transform(effort_SAMM_I_winter, crs = st_crs(marsouin_SAMM_I_winter))
effort_SAMM_II_winter <- st_transform(effort_SAMM_II_winter, crs = st_crs(marsouin_SAMM_II_winter))
effort_SCANS_III_summer <- st_transform(effort_SCANS_III_summer, crs = st_crs(marsouin_SCANS_III_summer))


m_SAMM_I_summer <- st_intersection(effort_SAMM_I_summer, marsouin_SAMM_I_summer)
m_SAMM_I_winter <- st_intersection(effort_SAMM_I_winter, marsouin_SAMM_I_winter)
m_SAMM_II_winter <- st_intersection(effort_SAMM_II_winter, marsouin_SAMM_II_winter)
m_SCANS_III_summer <- st_intersection(effort_SCANS_III_summer, marsouin_SCANS_III_summer)


# Grabbing the area
# This gives me erroneous areas

m_SAMM_I_summer$new_area <- st_area(m_SAMM_I_summer)
m_SAMM_I_summer$new_area <- as.numeric(m_SAMM_I_summer$new_area)


m_SAMM_I_winter$new_area <- st_area(m_SAMM_I_winter)
m_SAMM_II_winter$new_area <- st_area(m_SAMM_II_winter)
m_SCANS_III_summer$new_area <- st_area(m_SCANS_III_summer)


# Initially I just took the un-adjusted fishing_effort (meaning, not adjusted with statistic-rectangle area) due
# to the fact the code wasn't working 
# This gives us hours fished/m2

m_SAMM_I_summer$adjusted_effort <- m_SAMM_I_summer$total_hrs_fish / m_SAMM_I_summer$area
m_SAMM_I_summer$log_effort <- log(m_SAMM_I_summer$adjusted_effort)
m_SAMM_I_summer$normalized_effort <- scale(m_SAMM_I_summer$adjusted_effort, center = T, scale = T)

# Adjusting effort according to area hrs/km2

m_SAMM_I_winter$adjusted_effort <- m_SAMM_I_winter$total_hrs_fish / m_SAMM_I_winter$area
m_SAMM_I_winter$log_effort <- log(m_SAMM_I_winter$adjusted_effort)

m_SAMM_II_winter$adjusted_effort <- m_SAMM_II_winter$total_hrs_fish / m_SAMM_II_winter$area
m_SAMM_II_winter$log_effort <- log(m_SAMM_II_winter$adjusted_effort)

m_SCANS_III_summer$adjusted_effort <- m_SCANS_III_summer$total_hrs_fish / m_SCANS_III_summer$area
m_SCANS_III_summer$log_effort <- log(m_SCANS_III_summer$adjusted_effort)



# However, OFB puts fish hours and dolphin density in log? and then does the risk index?
# Plotted only for SAMM_I_summer at first

m_SAMM_I_summer$risk_index <- m_SAMM_I_summer$adjusted_effort * m_SAMM_I_summer$density
m_SAMM_I_summer$log_risk_index <- log(m_SAMM_I_summer$adjusted_effort * m_SAMM_I_summer$density)


m_SAMM_I_winter$risk_index <- m_SAMM_I_winter$adjusted_effort * m_SAMM_I_winter$density
m_SAMM_I_winter$log_risk_index <- log(m_SAMM_I_winter$adjusted_effort * m_SAMM_I_winter$density)

m_SAMM_II_winter$log_risk_index <- log(m_SAMM_II_winter$adjusted_effort * m_SAMM_II_winter$density)
m_SAMM_II_winter$log_risk_index <- log(m_SAMM_II_winter$adjusted_effort * m_SAMM_II_winter$density)

m_SCANS_III_summer$normalized_risk_index <- scale(m_SCANS_III_summer$adjusted_effort * m_SCANS_III_summer$density)
m_SCANS_III_summer$log_risk_index <- log(m_SCANS_III_summer$adjusted_effort * m_SCANS_III_summer$density)


#SCANS_III_summer$risk_index <- SCANS_III_summer$log_effort * SCANS_III_summer$log_density

#Put in log initially and had unsatisfying results, so let's try classint 

rangex<-st_bbox(SAMM_I_summer)[c(1,3)]
rangey<-st_bbox(SAMM_I_summer)[c(2,4)]

# Remove # in front of facet_wrap to see risk per DCR_flottille (Fileyeurs, chalutiers de fond, chalutiers pélagiques)

a <- ggplot() + 
  theme_bw() +
  geom_sf(data = m_SAMM_I_summer, aes(fill = log_risk_index )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("SAMM_I_summer log_risk_index")



b <- ggplot() + 
  theme_bw() +
  geom_sf(data = m_SAMM_I_winter, aes(fill = log_risk_index )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("SAMM_I_winter log_risk_index")


c <- ggplot() + 
  theme_bw() +
  geom_sf(data = m_SAMM_II_winter, aes(fill = log_risk_index )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("SAMM_II_winter log_risk_index")


d <- ggplot() + 
  theme_bw() +
  geom_sf(data = m_SCANS_III_summer, aes(fill = log_risk_index )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("SCANS_III_summer log_risk_index")

ggarrange(a,b,c,d, labels = "Marsouins log(risk_index)/season")


```

##### + Maps of log(density, effort, risk) / season

```{r}

# Remove # in front of facet_wrap to see risk per DCR_flottille (Fileyeurs, chalutiers de fond, chalutiers pélagiques)
# There is an issue however when looking at specific flottille, can't figure out why the borders don't show up


# SAMM_I_summer

a1 <- ggplot() + 
  theme_bw() +
  geom_sf(data = m_SAMM_I_summer, aes(fill = log_density )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("log_density")


a2 <- ggplot() + 
  theme_bw() +
  geom_sf(data = m_SAMM_I_summer, aes(fill = log_effort )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("log_effort")


a3 <- ggplot() + 
  theme_bw() +
  geom_sf(data = m_SAMM_I_summer, aes(fill = log_risk_index )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("log_risk_index")

ggarrange(a1,a2,a3, labels = "Marsouins SAMM_I_summer")

#####################################################################

# SAMM_I_winter

b1 <- ggplot() + 
  theme_bw() +
  geom_sf(data = m_SAMM_I_winter, aes(fill = log_density )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("log_density")


b2 <- ggplot() + 
  theme_bw() +
  geom_sf(data = m_SAMM_I_winter, aes(fill = log_effort )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("log_effort")


b3 <- ggplot() + 
  theme_bw() +
  geom_sf(data = m_SAMM_I_winter, aes(fill = log_risk_index )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("log_risk_index")

ggarrange(b1,b2,b3, labels = "Marsouins SAMM_I_winter")


#####################################################################


# SAMM_II_winter

c1 <- ggplot() + 
  theme_bw() +
  geom_sf(data = m_SAMM_II_winter, aes(fill = log_density )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("log_density")


c2 <- ggplot() + 
  theme_bw() +
  geom_sf(data = m_SAMM_II_winter, aes(fill = log_effort )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("log_effort")


c3 <- ggplot() + 
  theme_bw() +
  geom_sf(data = m_SAMM_II_winter, aes(fill = log_risk_index )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("log_risk_index")

ggarrange(c1,c2,c3, labels = "Marsouins SAMM_II_winter")


#####################################################################

# SCANS_III_summer

d1 <- ggplot() + 
  theme_bw() +
  geom_sf(data = m_SCANS_III_summer, aes(fill = log_density )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("log_density")


d2 <- ggplot() + 
  theme_bw() +
  geom_sf(data = m_SCANS_III_summer, aes(fill = log_effort )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("log_effort")


d3 <- ggplot() + 
  theme_bw() +
  geom_sf(data = m_SCANS_III_summer, aes(fill = log_risk_index )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("log_risk_index")

ggarrange(d1,d2,d3, labels = "Marsouins SCANS_III_summer")




```


# Birds

## Bird data

```{r Laridés spp}


#print(unique(meg_polygons$taxon))

#  "Petit_delphinine" "DELDEL"  "DELSPP"   "PHOPHO"   

# "TURTRU" tursiops truncatus 

# "Alcidae"  

# "Goeland_gris"  "Goeland_noir"  

# "LARGUL"  "LARMIN"   

# "LARSPP" Laridae spp 

# "Procellaridae"   

# "SULBAS"  
# "RISTRI" Rissa tridactyla (mouette tridactyle)"Mouette"         
 
dd_dist <- meg_polygons %>%
  filter(taxon %in% "LARSPP")
dd_dist <- na.omit(dd_dist)


## Creating class intervals
#classes <- classIntervals(dd_dist$abund, n = 5, style = "quantile")
#dd_dist <- dd_dist %>%
#  mutate(percent_class = cut(abund, classes$brks, include.lowest = T))
#dd_dist <- dd_dist %>% select (taxon,abund, percent_class,session_global, geom)%>%st_as_sf()

dd_dist$norm_abund <- norm_minmax(dd_dist$density)

dd_dist$abund_normalized <- scale(dd_dist$abund, center = min(dd_dist$abund), scale = max(dd_dist$abund) - min(dd_dist$abund))

## Log abundance

dd_dist$log_abund <- log(dd_dist$abund)

#get the limx and limy for coord_sf
rangex<-st_bbox(dd_dist)[c(1,3)]
rangey<-st_bbox(dd_dist)[c(2,4)]

dd_abund <- ggplot() + 
  theme_bw()+
  geom_sf(data = dd_dist, aes(fill = percent_class))+
  borders("world", fill = "light grey", colour = "light grey") +
  #scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  scale_fill_manual(values = brewer.pal(n = length(unique(dd_dist$percent_class)), name = 'Spectral'),
                    name = "#") +  
  coord_sf(rangex, rangey) +
  xlab("Longitude") + ylab("Latitude") +
  ggtitle("Laridés abundance")+
  facet_wrap(~ session_global)
dd_abund

## Laridés norm_abund  

norm_abund <- ggplot() + 
  theme_bw()+
  geom_sf(data = dd_dist, aes(fill = abund_normalized))+
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  #scale_fill_manual(values = brewer.pal(n = length(unique(meg$percent_class)), name = 'Spectral'),
                    #name = "#") +  
  coord_sf(rangex, rangey) +
  xlab("Longitude") + ylab("Latitude") +
  ggtitle("Laridés norm_abund")+
  facet_wrap(~ session_global)
norm_abund

## Laridés norm_abund  

log_abund <- ggplot() + 
  theme_bw()+
  geom_sf(data = dd_dist, aes(fill = log_density))+
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  #scale_fill_manual(values = brewer.pal(n = length(unique(meg$percent_class)), name = 'Spectral'),
                    #name = "#") +  
  coord_sf(rangex, rangey) +
  xlab("Longitude") + ylab("Latitude") +
  ggtitle("Laridés log_abund")+
  facet_wrap(~ session_global)
log_abund

```

=======
---
title: "BYC_RISK"
author: "CMD"
format: html
editor: visual
---

# simplesacrois

## Data set-up

```{r data}
library(dplyr)
library(arrow)
library(ggplot2)
library(data.table)
library(readr)
library(sf)
library(stringr)


ds<-open_dataset("D:/Data/simplesacrois")

# Select zones in English Channel (27.7.e, 27.7.d) + 6 stat rectangles from 27.7.h

select_manche <- ds %>%
  filter(AN %in% c(2011,2012,2016,2021)) %>%
  filter(SECT_COD_SACROIS_NIV3 %in% c("27.7.e", "27.7.d") | 
           (SECT_COD_SACROIS_NIV3 == "27.7.h" & SECT_COD_SACROIS_NIV5 %in% c("27E3","27E4","26E4","26E3","25E3","25E4"))) %>%
  select(NAVS_COD, DATE_SEQ, MAREE_DATE_DEP, TP_NAVIRE_SACROIS,SECT_COD_SACROIS_NIV4, SECT_COD_SACROIS_NIV5, SECT_COD_SACROIS_NIV6) %>%
  collect()

# Remove data where fishing hours aren't recorded
select_manche <- subset(select_manche,!is.na(TP_NAVIRE_SACROIS))


```

### Seasons + NAVS_COD_YEAR

```{r adding seasons}

####################################################################################

                        ########## ADDING SEASONS ##########


library(dplyr)
library(lubridate)

# Creating month, year, season columns
select_manche$MAREE_DATE_DEP <- dmy_hms(select_manche$MAREE_DATE_DEP)
select_manche$Month <- month(select_manche$MAREE_DATE_DEP)
select_manche$Year <- year(select_manche$MAREE_DATE_DEP)

select_manche$Season <- cut(select_manche$Month, 
                            breaks = c(0, 3, 4, 8, 11, Inf), 
                            labels = c("Winter", "Spring", "Summer", "Fall", "Winter"),
                            include.lowest = TRUE)


####################################################################################

                        ########## NAVS_COD_YEAR ##########


#### Creation de NAVS_COD_YEAR pr match avec data de flottille

library(data.table)
select_manche <- as.data.table(select_manche)

# Create NAVS_COD_YEAR column by pasting NAVS_COD and DATE_SEQ
select_manche[, NAVS_COD_YEAR := paste(NAVS_COD, substr(DATE_SEQ, 7, 10), sep = "_")]
select_manche <- select(select_manche, -MAREE_DATE_DEP)

```

### FPC

```{r }

####################################################################################

                        ########## FPC LOAD & left_join ##########

# for loop to read data from 2020 - 2022
setwd("D:/Data")


FPC=data.table()

for (i in 2007:2023) {
  
  setwd(paste0("D:/Data/",i));
  
  FPC<-rbind(fread(dir(getwd(), pattern="ISIH-504549-vueAnnuelleFpc"), dec=",", encoding="Latin-1", select= c("NAVS_COD", "DATE_REF", "FLOTTILLE_IFREMER_LIB", "S_FLOTTILLE_IFREMER_LIB", "DCR_FLOTTILLE_LIB", "DCR_S_FLOTTILLE_LIB", "DCR_S_S_FLOTTILLE_LIB", "NAVLC8_COD")), FPC)
}

#"NAVLC1_COD","NAVLC2_COD","NAVLC3_COD","NAVLC4_COD","NAVLC5_COD","NAVLC6_COD", "NAVLC7_COD", "NAVLC8_COD", #"NAVLC9_COD"
### Produce unique vessel ID based on year

FPC$NAVS_COD_YEAR=paste(FPC[,NAVS_COD], str_sub(FPC[,DATE_REF],7,10), sep="_")
FPC[,c("DATE_REF", "NAVS_COD"):=NULL]

#Keep only the ones that match w select_manche

FPC=FPC[NAVS_COD_YEAR %in% unique(select_manche[,NAVS_COD_YEAR]),]


####

select_manche <- select_manche %>%
  left_join(FPC, by = c("NAVS_COD_YEAR" = "NAVS_COD_YEAR")) %>%
  filter (DCR_FLOTTILLE_LIB %in% c("Chalutiers de fond", "Chalutiers pélagiques", "Fileyeurs"))

```

### Rectangle geometry

```{r}

####################################################################################

                        ########## Geometry data ##########

rect <- readRDS("D:/Data/rect.rds")

                        ########## left_join SACROIS ##########

select_manche <- select_manche %>%
  left_join(select(rect, SECT_COD,), by = c("SECT_COD_SACROIS_NIV5" = "SECT_COD"))


```

### ICES

```{r ICES}

#this isn't used nor can it be used since it doesn't work


ICES <- read_csv("D:/Data/Aires_decoupage_ICES.csv", col_types = cols(.default = "c"))


ICES <- ICES %>%
  filter(`ICES division` %in% c("27.7.e", "27.7.d") | 
           (`ICES division` == "27.7.h" & statistic_rectangle %in% c("27E3","27E4","26E4","26E3","25E3","25E4"))) 



####################################################################################

                        ########## AREA / RECTANGLE ##########


ICES$Area_stat_subrect_m2 <- as.numeric(ICES$Area_stat_subrect_m2)

# Some sub_rectangles appear in both divisions : we need to add up their areas and plug them back
# into one division (27.7.d), and re-calculate the statistic_rectangle area
# Then we can adjust fishing_effort based on the area of each statistic_rectangle and 
# Get a realistic representation of the fishing_effort in coastal areas for eg

####

# Grabbing the duplicated sub_rectangles appearing in both divisions and adding up their areas

rect_duplicates <- ICES %>%
  group_by(statistic_rectangle,statistic_subrectangle) %>%
  filter(n_distinct(`ICES division`) > 1) %>%
  summarise(duplicates_area = sum(as.numeric(Area_stat_subrect_m2)))
  
#si on fait les maths manuellement ca check out

# assigning a ICES division to duplicated rectangles, since they either fall in .d or .e 
# we put them in d since the largest area of each rectangle belongs to that section

rect_duplicates$`ICES division` <- "27.7.d"

# Summing up the area of duplicated s-rectangle values
#rect_duplicates <- rect_duplicates %>%
#  group_by(statistic_rectangle, satistic_subrectangle) %>%
#  summarise(total_area = sum(duplicates_area))

ICES2 <- ICES %>%
  left_join(rect_duplicates, by = c("statistic_rectangle", "statistic_subrectangle"))


ICES2 <- ICES %>%
  mutate(Area_stat_subrect_m2 = if_else(!is.na(rect_duplicates$duplicates_area), rect_duplicates$duplicates_area, Area_stat_subrect_m2), rect_duplicates$duplicates_area = NULL)



ICES2 <- ICES %>%
  mutate(Area_stat_subrect_m2 = if_else(!is.na(Area_stat_subrect_m2), Area_stat_subrect_m2, rect_duplicates$duplicates_area), Area_stat_subrect_m2 = NULL)












test <- ICES[c(1:10),]

test$Area_stat_rect_m2 <- as.numeric(test$Area_stat_rect_m2)
test <- as.data.frame(test)
test <- test %>% mutate (Area_stat_rect_m2 = Area_stat_rect_m2 * 100000)


ICES2 <- ICES %>%
  left_join(rect_duplicates, by = "statistic_subrectangle") %>%
  mutate(Area_stat_subrect_m2 = ifelse(!is.na(duplicates_area), duplicates_area, Area_stat_subrect_m2)) %>%
  select(-duplicates_area)

ICES3 <- ICES2[!duplicated(ICES2$statistic_subrectangle), ]





ICES2 <- ICES2 %>%
  mutate(Area_stat_subrect_m2 = if_else(!is.na(duplicates_area), duplicates_area, Area_stat_subrect_m2),
         duplicates_area = NULL)

# The sub_rectangles duplicated in both divisions are still present in the dataset
# The new area of each statistic_rectangle also needs to be calculated
# Blanking on how to do that rn 

#use unique(ICES, stat_rectangle) puis faire some et make sure there're different values?


# Left join with select_manche data set 
select_manche <- select_manche %>%
  left_join(select(ICES, statistic_rectangle, Area_stat_rect_m2), 
            by = c("SECT_COD_SACROIS_NIV5" = "statistic_rectangle"))


```

### Campagnes names

```{r campagnes names}


# Grabbing specific year/months combos to match with Pelagis' megafauna surveys

manche_SAMM_I_summer <- select_manche %>%
  filter((Year == 2012 & Month %in% c(6,7,8)))

manche_SAMM_I_winter <- select_manche %>%
  filter((Year == 2011 & Month %in% c(11,12))|
  (Year == 2012 & Month %in% c(1,2)))

manche_SAMM_II_winter <- select_manche %>%
  filter((Year == 2021 & Month %in% c(1,2,3)))

manche_SCANS_III_summer <- select_manche %>%
  filter((Year == 2016 & Month %in% c(6,7,8)))

# Added June & August for summers, otherwise we don't have enough data

# Adding a column to each data table indicating its source which will match the name of megafauna surveys 

manche_SAMM_I_summer <- manche_SAMM_I_summer %>%
  mutate(Source = "manche_SAMM_I_summer")

manche_SAMM_I_winter <- manche_SAMM_I_winter %>%
  mutate(Source = "manche_SAMM_I_winter")

manche_SAMM_II_winter <- manche_SAMM_II_winter %>%
  mutate(Source = "manche_SAMM_II_winter")

manche_SCANS_III_summer <- manche_SCANS_III_summer %>%
  mutate(Source = "manche_SCANS_III_summer")


# Remove select_manche to alleviate environment 

rm(select_manche)


# Combine the data tables

manche_campagnes <- bind_rows(
  manche_SAMM_I_summer,
  manche_SAMM_I_winter,
  manche_SAMM_II_winter,
  manche_SCANS_III_summer
)




```

# Fishing effort / flottille

```{r EFFORT / FLOTTILLE}

####################################################################################

                        ########## EFFORT / FLOTTILLE ##########

# Removing any rows with nothing in it 

manche_campagnes <- manche_campagnes %>%
  filter(SECT_COD_SACROIS_NIV5 != "")

# Fishing effort based on fishing hours per DCR_FLOTTILLE 

fish_effort <- manche_campagnes %>%
  distinct(NAVS_COD_YEAR,.keep_all = TRUE) %>%
  group_by(DCR_FLOTTILLE_LIB, SECT_COD_SACROIS_NIV5, Source, geometry) %>%
  summarize(
    mean_hrs_fish = mean(TP_NAVIRE_SACROIS, na.rm = TRUE),
    total_hrs_fish = sum(TP_NAVIRE_SACROIS, na.rm = TRUE))


fish_effort <- fish_effort %>%
  filter_all(all_vars(!is.na(.))) 



####################################################################################

                        ########## EFFORT / RECTANGLE AREA ##########

# We now have the total fishing hours per DCR_FLOTTILLE
# We have to adjust it based on the new area data (i.e., sea surface area without land = terres émergentes)
# I skipped this part due to the fact I was doing an st_intersection with Megafauna's grid 
# Where I'll have to re-ajust the effort based on the (adjusted) megafauna area (which also adjusted for sea surface area without land)
# IMO if the end goal is to map bycatch risk, then running this code isn't necessary, it won't affect end results if it is run however. 
# It is necessary if we want to map fishing effort



####### ! This code is useless as of right now due to the fact adjusted area still isn't fixed ! #########
# (I keep working on this code and thinking I've fixed it, and then I go back later and it is, indeed, not fixed)


#### fish_effort / rectangle area 


#Area_rectangle <- rect %>% 
#  left_join(ICES_rect, by = c("SECT_COD" = "statistic_rectangle"))%>%
#  distinct(SECT_COD, .keep_all = TRUE) 
  
#Area_rectangle <- Area_rectangle %>% filter (F_DIVISION %in% c("27.7.e","27.7.d","27.7.h"))


# In theory this adds the area data to the fish_effort dataset but it's doing something weird and adding a bunch of rows and brain is dead rn so will do that tomorrow yay

#fish_effort2 <- fish_effort %>%
#  left_join(select(Area_rectangle, Area_stat_rect_m2), by = c("SECT_COD_SACROIS_NIV5" = "SECT_COD"))




#select_manche <- select_manche %>%
#  left_join(select(rect, SECT_COD,), by = c("SECT_COD_SACROIS_NIV5" = "SECT_COD"))

#### calculation of fish effort that is proportionate to the rectangle area 
#manche_campagnes$Area_stat_rect_m2 <- as.numeric(manche_campagnes$Area_stat_rect_m2)
#manche_campagnes$effort_per_unit_area <- manche_campagnes$total_fish_hrs / manche_campagnes$Area_stat_rect_m2


# put in log for better visualization 

#fish_effort$log_fish_effort <- log(fish_effort$total_hrs_fish)

#####

# Very redundant and maybe there's a more concise way of going about this
# But I need to calculate/grab fishing effort per megafauna survey period so 
# When I do the st_intersection, the data matches and doesn't take forever to load

fish_effort <- fish_effort %>% st_as_sf()

fish_effort$log_effort <- log(fish_effort$total_hrs_fish)


effort_SAMM_I_summer <- fish_effort %>%
  filter(Source == "manche_SAMM_I_summer")
effort_SAMM_I_winter <- fish_effort %>%
  filter(Source == "manche_SAMM_I_winter")
effort_SAMM_II_winter <- fish_effort %>%
  filter(Source == "manche_SAMM_II_winter")
effort_SCANS_III_summer <- fish_effort %>%
  filter(Source == "manche_SCANS_III_summer")





```

### Fish_effort maps

```{r fishing effort map}

############### map w area effort


#get the limx and limy for coord_sf
rangex<-st_bbox(fish_effort)[c(1,3)]
rangey<-st_bbox(fish_effort)[c(2,4)]


map<-ggplot()+theme_bw()+
  geom_sf(data=fish_effort,aes(fill=log_effort ))+
  borders("world",fill="light grey",colour="light grey")+
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(rangex,rangey)+
  xlab("Longitude")+ylab("Latitude")+
  ggtitle("log Fishing effort per survey season")+
  facet_wrap(~Source)
map


# manche_SAMM_I_summer


ggplot() +
  theme_bw() +
  geom_sf(data = effort_SAMM_I_summer,
          aes(fill = log_effort)) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette = 'Spectral', name = "Value (unit)") +
  coord_sf(xlim = rangex, ylim = rangey) +  # Assuming `rangex` and `rangey` are defined
  xlab("Longitude") + ylab("Latitude") +
  ggtitle("log_effort manche_SAMM_I_summer") +
  facet_wrap(~ DCR_FLOTTILLE_LIB)


# manche_SAMM_I_winter

ggplot() +
  theme_bw() +
  geom_sf(data = effort_SAMM_I_winter,
          aes(fill = log_effort)) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette = 'Spectral', name = "Value (unit)") +
  coord_sf(xlim = rangex, ylim = rangey) +  # Assuming `rangex` and `rangey` are defined
  xlab("Longitude") + ylab("Latitude") +
  ggtitle("log_effort manche_SAMM_I_winter") +
  facet_wrap(~ DCR_FLOTTILLE_LIB)



# manche_SAMM_II_winter


ggplot() +
  theme_bw() +
  geom_sf(data = effort_SAMM_II_winter,
          aes(fill = log_effort)) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette = 'Spectral', name = "Value (unit)") +
  coord_sf(xlim = rangex, ylim = rangey) +  # Assuming `rangex` and `rangey` are defined
  xlab("Longitude") + ylab("Latitude") +
  ggtitle("log_effort manche_SAMM_II_winter") +
  facet_wrap(~ DCR_FLOTTILLE_LIB)





# manche_SCANS_III_summer


ggplot() +
  theme_bw() +
  geom_sf(data = effort_SCANS_III_summer,
          aes(fill = log_effort)) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette = 'Spectral', name = "Value (unit)") +
  coord_sf(xlim = rangex, ylim = rangey) +  # Assuming `rangex` and `rangey` are defined
  xlab("Longitude") + ylab("Latitude") +
  ggtitle("log_effort manche_SCANS_III_summer") +
  facet_wrap(~ DCR_FLOTTILLE_LIB)





### Count the number of vessels per year per DCR_FLOTTILLE since Chalutiers pélagiques 
# aren't as spread out as the others

vessel_count <- data.frame()
unique_years <- unique(manche_campagnes$Year)

# Loop
for (year in unique_years) {
  
    manche_year <- manche_campagnes %>%
    filter(Year == year)
  
    counts <- manche_year %>%
    group_by(DCR_FLOTTILLE_LIB) %>%
    summarise(boat_count = n_distinct(NAVS_COD_YEAR))
  
    counts$Year <- year
  
  vessel_count <- bind_rows(vessel_count, counts)
}

print(vessel_count)

# Very few chalutiers pélagiques vessels (29,32,4,6 for each campagnes respectively) 
# Need to look at the overall data if the proportions are as drastic and if they aren't simply fishing at 
# Different times of the year. 

```

# Bycatch data

```{r }
 


####################################################################################

                        ########## SACROIS BYC ##########

 setwd("D:/Data")

library(data.table)

DECL_BYC=data.table()

for (i in 2019:2023) {
  setwd(paste0('D:/Data/',i));
  DECL_BYC<-rbind(fread(paste0("CAPTURES-ACC-IFR_",i,".txt"), dec=",", encoding="Latin-1", colClasses=c("SECT_COD_SACROIS_NIV5"="character")), DECL_BYC, fill = T)
}
 
DECL_BYC <- DECL_BYC %>% 
  filter(SECT_COD_SACROIS_NIV3 %in% c("27.7.e", "27.7.d", "27.7.h") | 
           (SECT_COD_SACROIS_NIV3 == "27.7.h" & SECT_COD_SACROIS_NIV5 %in% c("27E3","27E4","26E3","26E3","25E3","25E3"))) %>%
  collect()


DECL_BYC$NAVS_COD_YEAR=paste(DECL_BYC[,NAVS_COD], str_sub(DECL_BYC[,AN]), sep="_")

DECL_BYC <- DECL_BYC %>%
  left_join(FPC, by = c("NAVS_COD_YEAR" = "NAVS_COD_YEAR"))


# Only 3/13 has DCR_FLOTTILLE_LIB reported...


####################################################################################

                        ########## OBSMER BYC ##########


setwd("D:/Data")
BYC <- read.table("sp_byc_3.csv", header = T, sep = ",")


BYC <- BYC %>% 
  filter(ZONE %in% c("27.7.e", "27.7.d", "27.7.h") | 
           (ZONE == "27.7.h" & RECTANGLE %in% c("27E3","27E4","26E3","26E3","25E3","25E3"))) %>%
  collect()

sp_byc <- BYC %>%
  left_join(FPC, by = c("NAVS_COD_YEAR" = "NAVS_COD_YEAR"))




```

### byc brouillon

```{r}

# Number of unspecified DCR_FLOTTILLE

sp_byc <- sp_byc %>% filter( ESPECE %in% c("Delphinus delphis", "Phocoena phocoena")) 

NA_byc <- sum(is.na(sp_byc$DCR_FLOTTILLE_LIB)) / length(sp_byc$DCR_FLOTTILLE_LIB)

# 66% of dolphin/porpoise byc has no DCR_FLOTTILLE specified 
# Same goes for specified boat length

byc_per_vessel <- sp_byc %>%
  group_by(ID_NAVIRE, ESPECE) %>%
  summarise(number_byc = n()) %>%
  arrange(number_byc)

byc_table <- byc_per_vessel %>%
  pivot_wider(names_from = ESPECE, values_from = number_byc, values_fill = 0)

# One vessel (chalut) has 11 byc of dolphins (2009,2011,2012), all during the winter (01, 02, 03)



library(lubridate)


sp_byc$DATE_FIN <- dmy_hms(sp_byc$DATE_FIN)
sp_byc$Month <- month(sp_byc$DATE_FIN)
sp_byc$Year <- year(sp_byc$DATE_FIN)

sp_byc$Season <- cut(sp_byc$Month, 
                            breaks = c(0, 3, 4, 8, 11, Inf), 
                            labels = c("Winter", "Spring", "Summer", "Fall", "Winter"),
                            include.lowest = TRUE)



#byc_sacrois_match <- sp_byc %>%
#  left_join(select_manche2, by = c("NAVS_COD_YEAR" = "NAVS_COD_YEAR"))



```

# Fishing effort, density, bycatch risk

## Megafauna

### Loading data

```{r Megafauna distribution data}

library(classInt)
library(dplyr)
library(sf)
library(ggplot2)
library(RColorBrewer)
library(data.table)
library(ggpubr) 

setwd("D:/Data")
megafauna <- read_sf("20240214_ModelMegafauneSAMM.gpkg") #This file contains dolphin, porpoise, and seabirds
#no seal info? cant find column breakdown in files

lon_min <- -9
lon_max <- 2
lat_min <- 47.5
lat_max <- 51.5

megafauna <- megafauna %>%
  filter(lon >= lon_min & lon <= lon_max & lat >= lat_min & lat <= lat_max)



# Load ICES polygon data
# Filter on the regions we want 

setwd("D:/Data")
ICES_data <- st_read("ICES_Areas_20160601_cut_dense_3857.shp")
ICES_data <- ICES_data %>% filter(Area_Full %in% c("27.7.d", "27.7.e", "27.7.h")) %>%
  select(Area_Full, geometry)
# Load megafauna data 
# Make sure coordinate system is the same as ICES_data
megafauna <- st_transform(megafauna, crs = st_crs(ICES_data))


#intersection of megafauna polygons with ICES_data to have accurate area of coastal polygons

meg_polygons <- st_intersection(megafauna, ICES_data)
# meg_polygons$meg_area <- st_area(meg_polygons) <-- st_area gives me weird values, disregarding st_area for the time being
#i'll use the area of the megafauna dataset (pelagis) later on to adjust fishing effort



# Grabbing dolphin density (#/km2)

meg_polygons$density <- meg_polygons$abund / meg_polygons$area
meg_polygons$log_density <- log(meg_polygons$density)

# putting density in log for better visualization

# testing other ways to normalize data for better visualization
# this did not work (uniform color on map), the min max normalization did not have better results either

#meg_polygons$normalized_density <- scale(meg_polygons$density, 
                                         #center = min(meg_polygons$density), 
                                         #scale = max(meg_polygons$density) - min(meg_polygons$density))

#meg_polygons$normalized_density <- scale(meg_polygons$density)



```
### Distribution

#### Delphinus delphis distribution

```{r DELDEL}

########## DAUPHINS 
dd_dist <- meg_polygons %>%
  filter(taxon %in% "DELDEL")
dd_dist <- na.omit(dd_dist)

#classes <- classIntervals(dd_dist$abund, n = 6, style = "quantile")
#dd_dist <- dd_dist %>%
#  mutate(percent_class = cut(abund, classes$brks, include.lowest = T))
#dd_dist <- dd_dist %>% select (taxon,abund, percent_class,season, geom)%>%st_as_sf()


#dd_dist$abund_normalized <- scale(dd_dist$abund, center = min(dd_dist$abund), scale = max(dd_dist$abund) - min(dd_dist$abund))

dd_dist$log_abund <- log(dd_dist$abund)

#get the limx and limy for coord_sf
rangex<-st_bbox(dd_dist)[c(1,3)]
rangey<-st_bbox(dd_dist)[c(2,4)]

dd_abund <- ggplot() + 
  theme_bw()+
  geom_sf(data = dd_dist, aes(fill = abund))+
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  #scale_fill_manual(values = brewer.pal(n = length(unique(meg$percent_class)), name = 'Spectral'),
                    #name = "#") +  
  coord_sf(rangex, rangey) +
  xlab("Longitude") + ylab("Latitude") +
  ggtitle("Delphinus delphis abundance")+
  facet_wrap(~ session_global)
dd_abund

dd_abund_log <- ggplot() + 
  theme_bw()+
  geom_sf(data = dd_dist, aes(fill = log_abund))+
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  #scale_fill_manual(values = brewer.pal(n = length(unique(meg$percent_class)), name = 'Spectral'),
                    #name = "#") +  
  coord_sf(rangex, rangey) +
  xlab("Longitude") + ylab("Latitude") +
  ggtitle("Delphinus delphis abund_log")+
  facet_wrap(~ session_global)
dd_abund_log

```

#### Phocoena phocoena distribution

```{r marsouin distribution}

########## MARSOUINS 

pp_dist <- meg_polygons %>%
  filter(taxon %in% "PHOPHO")
pp_dist <- na.omit(pp_dist)

#classes <- classIntervals(dd_dist$abund, n = 6, style = "quantile")
#dd_dist <- dd_dist %>%
#  mutate(percent_class = cut(abund, classes$brks, include.lowest = T))
#dd_dist <- dd_dist %>% select (taxon,abund, percent_class,season, geom)%>%st_as_sf()


pp_dist$log_abund <- log(pp_dist$abund)


#get the limx and limy for coord_sf
rangex<-st_bbox(pp_dist)[c(1,3)]
rangey<-st_bbox(pp_dist)[c(2,4)]

 pp_abund <-ggplot() + 
  theme_bw()+
  geom_sf(data = pp_dist, aes(fill = abund))+
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  #scale_fill_manual(values = brewer.pal(n = length(unique(meg$percent_class)), name = 'Spectral'),
                    #name = "#") +  
  coord_sf(rangex, rangey) +
  xlab("Longitude") + ylab("Latitude") +
  ggtitle("Phocoena phocoena abundance")+
  facet_wrap(~ session_global)
pp_abund

pp_abund_log <- ggplot() + 
  theme_bw()+
  geom_sf(data = pp_dist, aes(fill = log_abund))+
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  #scale_fill_manual(values = brewer.pal(n = length(unique(meg$percent_class)), name = 'Spectral'),
                    #name = "#") +  
  coord_sf(rangex, rangey) +
  xlab("Longitude") + ylab("Latitude") +
  ggtitle("Phocoena phocoena abund_log")+
  facet_wrap(~ session_global)
pp_abund_log


 pp_density <-ggplot() + 
  theme_bw()+
  geom_sf(data = pp_dist, aes(fill = density))+
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  #scale_fill_manual(values = brewer.pal(n = length(unique(meg$percent_class)), name = 'Spectral'),
                    #name = "#") +  
  coord_sf(rangex, rangey) +
  xlab("Longitude") + ylab("Latitude") +
  ggtitle("Phocoena phocoena density")+
  facet_wrap(~ session_global)
pp_density


```


### Bycatch risk maps

#### Delphinus delphis

```{r}


# Grabbing Delphinus delphis only to start 

dauphin <- meg_polygons %>% filter(taxon %in% "DELDEL")

# breaking down everything per season so st_intersection matches and doesn't take forever

dauphin_SAMM_I_summer <- dauphin %>%
  filter(session_global == "SAMM_1_summer")
dauphin_SAMM_I_winter <- dauphin %>%
  filter(session_global == "SAMM_1_winter")
dauphin_SAMM_II_winter <- dauphin %>%
  filter(session_global == "SAMM_2_winter")
dauphin_SCANS_III_summer <- dauphin %>%
  filter(session_global == "SCANS_3_summer")


# Converting coordinate systems
# matching the each data set with its corresponding season wasn't necessary but it was done anyways

effort_SAMM_I_summer <- st_transform(effort_SAMM_I_summer, crs = st_crs(dauphin_SAMM_I_summer))
effort_SAMM_I_winter <- st_transform(effort_SAMM_I_winter, crs = st_crs(dauphin_SAMM_I_summer))
effort_SAMM_II_winter <- st_transform(effort_SAMM_II_winter, crs = st_crs(dauphin_SAMM_I_summer))
effort_SCANS_III_summer <- st_transform(effort_SCANS_III_summer, crs = st_crs(dauphin_SAMM_I_summer))

# Intersecting each fishing effort per survey season with dolphin data per survey season


SAMM_I_summer <- st_intersection(effort_SAMM_I_summer, dauphin_SAMM_I_summer)
SAMM_I_winter <- st_intersection(effort_SAMM_I_winter, dauphin_SAMM_I_winter)
SAMM_II_winter <- st_intersection(effort_SAMM_II_winter, dauphin_SAMM_II_winter)
SCANS_III_summer <- st_intersection(effort_SCANS_III_summer, dauphin_SCANS_III_summer)


# Grabbing the area
# This gives me erroneous areas, i'm letting it run in the code but i'm disregarding it for now

SAMM_I_summer$new_area <- st_area(SAMM_I_summer)
SAMM_I_summer$new_area <- as.numeric(SAMM_I_summer$new_area)


SAMM_I_winter$new_area <- st_area(SAMM_I_winter)
SAMM_II_winter$new_area <- st_area(SAMM_II_winter)
SCANS_III_summer$new_area <- st_area(SCANS_III_summer)


# For now I've only taken the un-adjusted fishing_effort (meaning, not adjusted with statistic-rectangle area) due
# to the fact the code wasn't working 
# This gives us hours fished/m2


# Now i'm adjusting effort according to area (Pelagis grid) hrs/km2
SAMM_I_summer$adjusted_effort <- SAMM_I_summer$total_hrs_fish / SAMM_I_summer$area
SAMM_I_summer$log_effort <- log(SAMM_I_summer$adjusted_effort)


SAMM_I_winter$adjusted_effort <- SAMM_I_winter$total_hrs_fish / SAMM_I_winter$area
SAMM_I_winter$log_effort <- log(SAMM_I_winter$adjusted_effort)

SAMM_II_winter$adjusted_effort <- SAMM_II_winter$total_hrs_fish / SAMM_II_winter$area
SAMM_II_winter$log_effort <- log(SAMM_II_winter$adjusted_effort)

SCANS_III_summer$adjusted_effort <- SCANS_III_summer$total_hrs_fish / SCANS_III_summer$area
SCANS_III_summer$log_effort <- log(SCANS_III_summer$adjusted_effort)




# However, OFB puts fish hours and dolphin density in log? and then does the risk index?
# "L’indice de risque d’exposition est calculé suivant la formule suivante : DENSITE (ind/km2) x EFFORT DE PECHE (heures/mailles). Les deux paramètres (densités et efforts de pêches) sont log-normalisés vis-à-vis de la valeur maximale"
# The thing is if I do that, assuming the norm_minmax function is what OFB is talking about, the risk map looks really lame 

  ## Doing it for one season, found risk effort and mapped it (further down below)

norm_minmax <- function(x){
  (x- min(x)) /(max(x)-min(x))
}

SAMM_I_summer <- SAMM_I_summer[complete.cases(SAMM_I_summer$adjusted_effort), ]
SAMM_I_summer <- SAMM_I_summer[complete.cases(SAMM_I_summer$density), ]

SAMM_I_summer$normalized_effort <- norm_minmax(SAMM_I_summer$adjusted_effort)
SAMM_I_summer$normalized_density <- norm_minmax(SAMM_I_summer$density)





# Risk index


SAMM_I_summer$risk_index <- SAMM_I_summer$adjusted_effort * SAMM_I_summer$density
SAMM_I_summer$log_risk_index <- log(SAMM_I_summer$adjusted_effort * SAMM_I_summer$density)
SAMM_I_summer$norm_risk <- SAMM_I_summer$normalized_effort * SAMM_I_summer$normalized_density


SAMM_I_winter$risk_index <- SAMM_I_winter$adjusted_effort * SAMM_I_winter$density
SAMM_I_winter$log_risk_index <- log(SAMM_I_winter$adjusted_effort * SAMM_I_winter$density)

SAMM_II_winter$log_risk_index <- log(SAMM_II_winter$adjusted_effort * SAMM_II_winter$density)
SAMM_II_winter$log_risk_index <- log(SAMM_II_winter$adjusted_effort * SAMM_II_winter$density)

SCANS_III_summer$normalized_risk_index <- scale(SCANS_III_summer$adjusted_effort * SCANS_III_summer$density)
SCANS_III_summer$log_risk_index <- log(SCANS_III_summer$adjusted_effort * SCANS_III_summer$density)


#SCANS_III_summer$risk_index <- SCANS_III_summer$log_effort * SCANS_III_summer$log_density

#Put in log initially and had unsatisfying results, so let's try classint 

rangex<-st_bbox(SAMM_I_summer)[c(1,3)]
rangey<-st_bbox(SAMM_I_summer)[c(2,4)]

# Remove # in front of facet_wrap to see risk per DCR_flottille (Fileyeurs, chalutiers de fond, chalutiers pélagiques)
# There is an issue however when looking at specific flottille, can't figure out why the borders don't show up

    # SAMM_I_summer map (a) is currently coded for normalized risk, not log risk
a <- ggplot() + 
  theme_bw() +
  geom_sf(data = SAMM_I_summer, aes(fill = norm_risk )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("SAMM_I_summer log_risk_index")
a


b <- ggplot() + 
  theme_bw() +
  geom_sf(data = SAMM_I_winter, aes(fill = log_risk_index )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("SAMM_I_winter log_risk_index")
b

c <- ggplot() + 
  theme_bw() +
  geom_sf(data = SAMM_II_winter, aes(fill = log_risk_index )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("SAMM_II_winter log_risk_index")
c

d <- ggplot() + 
  theme_bw() +
  geom_sf(data = SCANS_III_summer, aes(fill = log_risk_index )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("SCANS_III_summer log_risk_index")
d

#ggarrange(a,b,c,d, labels = "Delphinus delphis log(risk_index)/season")


#### mapping stuff 
#plot(risk_polygons$geom, col = 'lightblue')
#plot(megafauna$geom, col = "pink")




```

##### + Maps of log(density, effort, risk) / season

```{r more maps}

# Remove # in front of facet_wrap to see risk per DCR_flottille (Fileyeurs, chalutiers de fond, chalutiers pélagiques)
# There is an issue however when looking at specific flottille, can't figure out why the borders don't show up

# SAMM_I_summer

a1 <- ggplot() + 
  theme_bw() +
  geom_sf(data = SAMM_I_summer, aes(fill = log_density )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("log_density")


a2 <- ggplot() + 
  theme_bw() +
  geom_sf(data = SAMM_I_summer, aes(fill = log_effort )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("log_effort")


a3 <- ggplot() + 
  theme_bw() +
  geom_sf(data = SAMM_I_summer, aes(fill = log_risk_index )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("log_risk_index")

ggarrange(a1,a2,a3, labels = "Delphinus delphis SAMM_I_summer")

#####################################################################

# SAMM_I_winter

b1 <- ggplot() + 
  theme_bw() +
  geom_sf(data = SAMM_I_winter, aes(fill = log_density )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("log_density")


b2 <- ggplot() + 
  theme_bw() +
  geom_sf(data = SAMM_I_winter, aes(fill = log_effort )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("log_effort")


b3 <- ggplot() + 
  theme_bw() +
  geom_sf(data = SAMM_I_winter, aes(fill = log_risk_index )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("log_risk_index")

ggarrange(b1,b2,b3, labels = "Delphinus delphis SAMM_I_winter")


#####################################################################


# SAMM_II_winter

c1 <- ggplot() + 
  theme_bw() +
  geom_sf(data = SAMM_II_winter, aes(fill = log_density )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("log_density")


c2 <- ggplot() + 
  theme_bw() +
  geom_sf(data = SAMM_II_winter, aes(fill = log_effort )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("log_effort")


c3 <- ggplot() + 
  theme_bw() +
  geom_sf(data = SAMM_II_winter, aes(fill = log_risk_index )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("log_risk_index")

ggarrange(c1,c2,c3, labels = "Delphinus delphis SAMM_II_winter")


#####################################################################

# SCANS_III_summer

d1 <- ggplot() + 
  theme_bw() +
  geom_sf(data = SCANS_III_summer, aes(fill = log_density )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("log_density")


d2 <- ggplot() + 
  theme_bw() +
  geom_sf(data = SCANS_III_summer, aes(fill = log_effort )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("log_effort")


d3 <- ggplot() + 
  theme_bw() +
  geom_sf(data = SCANS_III_summer, aes(fill = log_risk_index )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("log_risk_index")

ggarrange(d1,d2,d3, labels = "Delphinus delphis SCANS_III_summer")



```

### Phocoena phocoena

```{r marsouins}

# Remove # in front of facet_wrap to see risk per DCR_flottille (Fileyeurs, chalutiers de fond, chalutiers pélagiques)
# There is an issue however when looking at specific flottille, can't figure out why the borders don't show up


marsouin <- meg_polygons %>% filter(taxon %in% "PHOPHO")


marsouin_SAMM_I_summer <- marsouin %>%
  filter(session_global == "SAMM_1_summer")
marsouin_SAMM_I_winter <- marsouin %>%
  filter(session_global == "SAMM_1_winter")
marsouin_SAMM_II_winter <- marsouin %>%
  filter(session_global == "SAMM_2_winter")
marsouin_SCANS_III_summer <- marsouin %>%
  filter(session_global == "SCANS_3_summer")


# Converting coordinate systems
# Intersecting each fishing effort per survey season with dolphin data per survey season

effort_SAMM_I_summer <- st_transform(effort_SAMM_I_summer, crs = st_crs(marsouin_SAMM_I_summer))
effort_SAMM_I_winter <- st_transform(effort_SAMM_I_winter, crs = st_crs(marsouin_SAMM_I_winter))
effort_SAMM_II_winter <- st_transform(effort_SAMM_II_winter, crs = st_crs(marsouin_SAMM_II_winter))
effort_SCANS_III_summer <- st_transform(effort_SCANS_III_summer, crs = st_crs(marsouin_SCANS_III_summer))


m_SAMM_I_summer <- st_intersection(effort_SAMM_I_summer, marsouin_SAMM_I_summer)
m_SAMM_I_winter <- st_intersection(effort_SAMM_I_winter, marsouin_SAMM_I_winter)
m_SAMM_II_winter <- st_intersection(effort_SAMM_II_winter, marsouin_SAMM_II_winter)
m_SCANS_III_summer <- st_intersection(effort_SCANS_III_summer, marsouin_SCANS_III_summer)


# Grabbing the area
# This gives me erroneous areas

m_SAMM_I_summer$new_area <- st_area(m_SAMM_I_summer)
m_SAMM_I_summer$new_area <- as.numeric(m_SAMM_I_summer$new_area)


m_SAMM_I_winter$new_area <- st_area(m_SAMM_I_winter)
m_SAMM_II_winter$new_area <- st_area(m_SAMM_II_winter)
m_SCANS_III_summer$new_area <- st_area(m_SCANS_III_summer)


# Initially I just took the un-adjusted fishing_effort (meaning, not adjusted with statistic-rectangle area) due
# to the fact the code wasn't working 
# This gives us hours fished/m2

m_SAMM_I_summer$adjusted_effort <- m_SAMM_I_summer$total_hrs_fish / m_SAMM_I_summer$area
m_SAMM_I_summer$log_effort <- log(m_SAMM_I_summer$adjusted_effort)
m_SAMM_I_summer$normalized_effort <- scale(m_SAMM_I_summer$adjusted_effort, center = T, scale = T)

# Adjusting effort according to area hrs/km2

m_SAMM_I_winter$adjusted_effort <- m_SAMM_I_winter$total_hrs_fish / m_SAMM_I_winter$area
m_SAMM_I_winter$log_effort <- log(m_SAMM_I_winter$adjusted_effort)

m_SAMM_II_winter$adjusted_effort <- m_SAMM_II_winter$total_hrs_fish / m_SAMM_II_winter$area
m_SAMM_II_winter$log_effort <- log(m_SAMM_II_winter$adjusted_effort)

m_SCANS_III_summer$adjusted_effort <- m_SCANS_III_summer$total_hrs_fish / m_SCANS_III_summer$area
m_SCANS_III_summer$log_effort <- log(m_SCANS_III_summer$adjusted_effort)



# However, OFB puts fish hours and dolphin density in log? and then does the risk index?
# Plotted only for SAMM_I_summer at first

m_SAMM_I_summer$risk_index <- m_SAMM_I_summer$adjusted_effort * m_SAMM_I_summer$density
m_SAMM_I_summer$log_risk_index <- log(m_SAMM_I_summer$adjusted_effort * m_SAMM_I_summer$density)


m_SAMM_I_winter$risk_index <- m_SAMM_I_winter$adjusted_effort * m_SAMM_I_winter$density
m_SAMM_I_winter$log_risk_index <- log(m_SAMM_I_winter$adjusted_effort * m_SAMM_I_winter$density)

m_SAMM_II_winter$log_risk_index <- log(m_SAMM_II_winter$adjusted_effort * m_SAMM_II_winter$density)
m_SAMM_II_winter$log_risk_index <- log(m_SAMM_II_winter$adjusted_effort * m_SAMM_II_winter$density)

m_SCANS_III_summer$normalized_risk_index <- scale(m_SCANS_III_summer$adjusted_effort * m_SCANS_III_summer$density)
m_SCANS_III_summer$log_risk_index <- log(m_SCANS_III_summer$adjusted_effort * m_SCANS_III_summer$density)


#SCANS_III_summer$risk_index <- SCANS_III_summer$log_effort * SCANS_III_summer$log_density

#Put in log initially and had unsatisfying results, so let's try classint 

rangex<-st_bbox(SAMM_I_summer)[c(1,3)]
rangey<-st_bbox(SAMM_I_summer)[c(2,4)]

# Remove # in front of facet_wrap to see risk per DCR_flottille (Fileyeurs, chalutiers de fond, chalutiers pélagiques)

a <- ggplot() + 
  theme_bw() +
  geom_sf(data = m_SAMM_I_summer, aes(fill = log_risk_index )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("SAMM_I_summer log_risk_index")



b <- ggplot() + 
  theme_bw() +
  geom_sf(data = m_SAMM_I_winter, aes(fill = log_risk_index )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("SAMM_I_winter log_risk_index")


c <- ggplot() + 
  theme_bw() +
  geom_sf(data = m_SAMM_II_winter, aes(fill = log_risk_index )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("SAMM_II_winter log_risk_index")


d <- ggplot() + 
  theme_bw() +
  geom_sf(data = m_SCANS_III_summer, aes(fill = log_risk_index )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("SCANS_III_summer log_risk_index")

ggarrange(a,b,c,d, labels = "Marsouins log(risk_index)/season")


```

##### + Maps of log(density, effort, risk) / season

```{r}

# Remove # in front of facet_wrap to see risk per DCR_flottille (Fileyeurs, chalutiers de fond, chalutiers pélagiques)
# There is an issue however when looking at specific flottille, can't figure out why the borders don't show up


# SAMM_I_summer

a1 <- ggplot() + 
  theme_bw() +
  geom_sf(data = m_SAMM_I_summer, aes(fill = log_density )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("log_density")


a2 <- ggplot() + 
  theme_bw() +
  geom_sf(data = m_SAMM_I_summer, aes(fill = log_effort )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("log_effort")


a3 <- ggplot() + 
  theme_bw() +
  geom_sf(data = m_SAMM_I_summer, aes(fill = log_risk_index )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("log_risk_index")

ggarrange(a1,a2,a3, labels = "Marsouins SAMM_I_summer")

#####################################################################

# SAMM_I_winter

b1 <- ggplot() + 
  theme_bw() +
  geom_sf(data = m_SAMM_I_winter, aes(fill = log_density )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("log_density")


b2 <- ggplot() + 
  theme_bw() +
  geom_sf(data = m_SAMM_I_winter, aes(fill = log_effort )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("log_effort")


b3 <- ggplot() + 
  theme_bw() +
  geom_sf(data = m_SAMM_I_winter, aes(fill = log_risk_index )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("log_risk_index")

ggarrange(b1,b2,b3, labels = "Marsouins SAMM_I_winter")


#####################################################################


# SAMM_II_winter

c1 <- ggplot() + 
  theme_bw() +
  geom_sf(data = m_SAMM_II_winter, aes(fill = log_density )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("log_density")


c2 <- ggplot() + 
  theme_bw() +
  geom_sf(data = m_SAMM_II_winter, aes(fill = log_effort )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("log_effort")


c3 <- ggplot() + 
  theme_bw() +
  geom_sf(data = m_SAMM_II_winter, aes(fill = log_risk_index )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("log_risk_index")

ggarrange(c1,c2,c3, labels = "Marsouins SAMM_II_winter")


#####################################################################

# SCANS_III_summer

d1 <- ggplot() + 
  theme_bw() +
  geom_sf(data = m_SCANS_III_summer, aes(fill = log_density )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("log_density")


d2 <- ggplot() + 
  theme_bw() +
  geom_sf(data = m_SCANS_III_summer, aes(fill = log_effort )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("log_effort")


d3 <- ggplot() + 
  theme_bw() +
  geom_sf(data = m_SCANS_III_summer, aes(fill = log_risk_index )) +
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  coord_sf(xlim = rangex, ylim = rangey) +
  xlab("Longitude") + ylab("Latitude") +
  #facet_wrap(~DCR_FLOTTILLE_LIB)
ggtitle("log_risk_index")

ggarrange(d1,d2,d3, labels = "Marsouins SCANS_III_summer")




```


# Birds

## Bird data

```{r Laridés spp}


#print(unique(meg_polygons$taxon))

#  "Petit_delphinine" "DELDEL"  "DELSPP"   "PHOPHO"   

# "TURTRU" tursiops truncatus 

# "Alcidae"  

# "Goeland_gris"  "Goeland_noir"  

# "LARGUL"  "LARMIN"   

# "LARSPP" Laridae spp 

# "Procellaridae"   

# "SULBAS"  
# "RISTRI" Rissa tridactyla (mouette tridactyle)"Mouette"         
 
dd_dist <- meg_polygons %>%
  filter(taxon %in% "LARSPP")
dd_dist <- na.omit(dd_dist)


## Creating class intervals
#classes <- classIntervals(dd_dist$abund, n = 5, style = "quantile")
#dd_dist <- dd_dist %>%
#  mutate(percent_class = cut(abund, classes$brks, include.lowest = T))
#dd_dist <- dd_dist %>% select (taxon,abund, percent_class,session_global, geom)%>%st_as_sf()

dd_dist$norm_abund <- norm_minmax(dd_dist$density)

dd_dist$abund_normalized <- scale(dd_dist$abund, center = min(dd_dist$abund), scale = max(dd_dist$abund) - min(dd_dist$abund))

## Log abundance

dd_dist$log_abund <- log(dd_dist$abund)

#get the limx and limy for coord_sf
rangex<-st_bbox(dd_dist)[c(1,3)]
rangey<-st_bbox(dd_dist)[c(2,4)]

dd_abund <- ggplot() + 
  theme_bw()+
  geom_sf(data = dd_dist, aes(fill = percent_class))+
  borders("world", fill = "light grey", colour = "light grey") +
  #scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  scale_fill_manual(values = brewer.pal(n = length(unique(dd_dist$percent_class)), name = 'Spectral'),
                    name = "#") +  
  coord_sf(rangex, rangey) +
  xlab("Longitude") + ylab("Latitude") +
  ggtitle("Laridés abundance")+
  facet_wrap(~ session_global)
dd_abund

## Laridés norm_abund  

norm_abund <- ggplot() + 
  theme_bw()+
  geom_sf(data = dd_dist, aes(fill = abund_normalized))+
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  #scale_fill_manual(values = brewer.pal(n = length(unique(meg$percent_class)), name = 'Spectral'),
                    #name = "#") +  
  coord_sf(rangex, rangey) +
  xlab("Longitude") + ylab("Latitude") +
  ggtitle("Laridés norm_abund")+
  facet_wrap(~ session_global)
norm_abund

## Laridés norm_abund  

log_abund <- ggplot() + 
  theme_bw()+
  geom_sf(data = dd_dist, aes(fill = log_density))+
  borders("world", fill = "light grey", colour = "light grey") +
  scale_fill_distiller(palette='Spectral',name="Value (unit)")+
  #scale_fill_manual(values = brewer.pal(n = length(unique(meg$percent_class)), name = 'Spectral'),
                    #name = "#") +  
  coord_sf(rangex, rangey) +
  xlab("Longitude") + ylab("Latitude") +
  ggtitle("Laridés log_abund")+
  facet_wrap(~ session_global)
log_abund

```

>>>>>>> 290a4685a2ded5e11edb2a12743dc00b0f82cbaa
